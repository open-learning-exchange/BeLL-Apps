/*Here I have made some course test scenario where test is done automatically while it renders all data in BeLL-App UI and couchdb.
For test scenario we have got multiple members, courses, steps , resources, questions adn a membercourseprogress as we need all 
these specific variables or a data that should be bulk inserted in a data base*/
/*For running this script we have to run node [filename][url] eg:node course_mock_data http://192.168.10.111:5982 */

var util = require('util')
var fs = require('fs')
var exec = require('child_process').exec;
var program = require('commander');
var databases = []
program
    .version('0.0.2')
    .parse(process.argv);
if (!program.args[0]) return console.log('No CouchDB URL provided. Quiting now.')
var couchUrl = program.args[0]
var nano = require('nano')(couchUrl)

function start() {
    increaseLimits()
}

// Increase Limits so couchapp push works correctly
function increaseLimits() {
    return createDummyCourses()
       
}
var n_members = 4;
var n_steps = 5;
var defaultCourses = []; //Contains only CourseID and MemberList
var defaultCoursestep = []; 
var defaultCoursequestion = [];
var defaultResources = [];
var defaultMembers = [];
var defaultCourseanswer = [];
var defaultMemberprogress = [];
var member_obj ={};
var member_arr = [[],[],[],[],[]];
var c_step ={};
var m_step = [[],[],[],[]];

function createDummyCourses() {
  var courses = nano.db.use('courses');
  var resources = nano.db.use('resources');
  var coursestep = nano.db.use('coursestep');
  var coursequestion = nano.db.use('coursequestion');
  var members = nano.db.use('members');
  var courseanswer = nano.db.use('courseanswer');
  var membercourseprogress = nano.db.use('membercourseprogress');

  /***************Members***************/
    //First you need to create Member:

  for(var member = 0; member < n_members; member++){
    participation = member + 1;
    if(member< parseInt(n_members/2)){
      defaultMembers.push({
        "login": "member" + participation,
        "kind": "Member",
        "roles": ["Manager"],
        "firstName": "Member " + participation,
        "lastName": "Member " + participation,
        "password": "password",
        "Gender": "Male",
        "status": "active",
        "email": "member" + participation + ".somalia@olebell.org",
        "visits": 0,
        "BirthDate": "01/01/1985"
      });
    }else{
      defaultMembers.push({
        "login": "member" + participation,
        "kind": "Member",
        "roles": ["Learner"],
        "firstName": "Member " + participation,
        "lastName": "Member " + participation,
        "password": "password",
        "Gender": "Male",
        "status": "active",
        "email": "member" + participation + ".somalia@olebell.org",
        "visits": 0,
        "BirthDate": "01/01/1985"
      });
    }
  }

  members.bulk({"docs":defaultMembers}, function(err, resmem) {
    if (err)
      return console.log(err);
    else {
        for (var i = 0; i < 4; i++) {
         member_arr[0].push(resmem[i].id)
        }
        member_obj[resmem[0].id] = member_arr[0]
        for (var b = 0; b < 3; b++) {
           member_arr[1].push(resmem[b].id)
        }
        member_obj[resmem[1].id] = member_arr[1]
        for (var i = 0; i < 2; i++) {
          member_arr[2].push(resmem[i].id)
        }
        member_obj[resmem[2].id] = member_arr[2]
        for (var i = 0; i < 1; i++) {
          member_arr[3].push(resmem[i].id)
        }
        member_obj[resmem[3].id] = member_arr[3]
        for (var i = 0; i < 0; i++) {
          member_arr[4].push(resmem[i].id)
        }

        for(var course = 0; course < resmem.length; course++){
        course_number = course + 1;
        var subjectLevel;
        var gradelevel;
        if (course <=3){
            subjectLevel = "Amateur";
            gradelevel = "Higher"
        }else if(course>=4){
            subjectLevel = "Mid";
            gradelevel="10"
        }else{
            subjectLevel = "Beginner";
            gradelevel="5"
        }
        //insert into courses
        defaultCourses.push({
            "CourseTitle": "Course " +course_number,
            "Day": "0",
            "backgroundColor": "",
            "courseLeader": "",
            "description": "This is Course " +course_number+" .",
            "endDate": "12/12/2017",
            "endTime": "17:00",
            "foregroundColor": "",
            "gradeLevel": gradelevel,
            "kind": "Course",
            "languageOfInstruction": "English",
            "location": "Alberta",
            "memberLimit": "20",
            "members": member_obj[Object.keys(member_obj)[course]],
            "method": "Theory and Practical",
            "name": "Course " +course_number,
            "startDate": "01/01/2017",
            "startTime": "10:00",
            "subjectLevel": subjectLevel
        });
      }
      courses.bulk({"docs":defaultCourses}, function(err, rescourse) {
        if (err)
            return console.log(err);
        else{
            //insert into Resources
            defaultResources.push({
               "kind": "Resource",
               "status": "accepted",
               "title": "Resource1",
               "author": "s",
               "Publisher": "ds",
               "language": "English",
               "Year": "s",
               "linkToLicense": "dsd",
               "subject": [
                   "Agriculture",
                   "Arts",
                   "Business and Finance",
                   "Environment",
                   "Food and Nutrition",
                   "Geography",
                   "Health and Medicine",
                   "History",
                   "Human Development",
                   "Languages",
                   "Law",
                   "Learning",
                   "Literature",
                   "Math",
                   "Music",
                   "Politics and Government",
                   "Reference",
                   "Religion",
                   "Science",
                   "Social Sciences",
                   "Sports",
                   "Technology"
               ],
               "Level": [
                   "Professional"
               ],
               "Tag": null,
               "Medium": "Text",
               "openWith": "PDF.js",
               "resourceFor": "Leader",
               "resourceType": "Textbook",
               "uploadDate": "2017-10-10T18:15:00.000Z",
               "averageRating": "",
               "articleDate": "2017-10-10T18:15:00.000Z",
               "addedBy": "admin",
               "openUrl": "",
               "openWhichFile": "",
               "need_optimization": true,
               "sum": 0,
               "timesRated": 0
            });
            resources.bulk({"docs":defaultResources},function(err,resreso){
                if(err){
                    console.log(err);
                }else{
                    var courseIdlist = [];
                    for(var i = 0; i < defaultCourses.length; i++){
                        courseIdlist.push(rescourse[i].id)
                    }
                      for(var courselist = 0; courselist < rescourse.length; courselist++){
                        if(courselist == 1){
                            n_steps = 1
                            for(var steps = 0; steps < n_steps; steps++){
                                defaultCoursestep.push({
                                    "courseId": rescourse[courselist].id,
                                    "description": "This is course step "+ (steps+1),
                                    "kind": "Course Step",
                                    "passingPercentage": "30",
                                    "resourceTitles":["Resources"],
                                    "resourceId":[resreso[0].id],
                                    "questionslist":[],
                                    "step": steps+1,
                                    "stepGoals": "Knowledge",
                                    "stepMethod": "Theory",
                                    "title": "Course Step "+ (steps+1),
                                    "totalMarks": "100"
                                });
                            }
                        }else if(courselist == 2){
                            n_steps = 2
                            for(var steps = 0; steps < n_steps; steps++){
                                  defaultCoursestep.push({
                                    "courseId": rescourse[courselist].id,
                                    "description": "This is course step "+ (steps+1),
                                    "kind": "Course Step",
                                    "passingPercentage": "30",
                                    "resourceTitles":["Resources"],
                                    "resourceId":[resreso[0].id],
                                    "questionslist":[],
                                    "step": steps+1,
                                    "stepGoals": "Knowledge",
                                    "stepMethod": "Theory",
                                    "title": "Course Step "+ (steps+1),
                                    "totalMarks": "100"
                                });
                            }
                        }else if(courselist == 3){
                            n_steps = 3
                            for(var steps = 0; steps < n_steps; steps++){
                                  defaultCoursestep.push({
                                    "courseId": rescourse[courselist].id,
                                    "description": "This is course step "+ (steps+1),
                                    "kind": "Course Step",
                                    "passingPercentage": "30",
                                    "resourceTitles":["Resources"],
                                    "resourceId":[resreso[0].id],
                                    "questionslist":[],
                                    "step": steps+1,
                                    "stepGoals": "Knowledge",
                                    "stepMethod": "Theory",
                                    "title": "Course Step "+ (steps+1),
                                    "totalMarks": "100"
                                });
                            }
                        }else{
                           for(var steps = 0; steps < n_steps; steps++){
                                  defaultCoursestep.push({
                                    "courseId": rescourse[courselist].id,
                                    "description": "This is course step "+ (steps+1),
                                    "kind": "Course Step",
                                    "passingPercentage": "30",
                                    "resourceTitles":["Resources"],
                                    "resourceId":[resreso[0].id],
                                    "questionslist":[],
                                    "step": steps+1,
                                    "stepGoals": "Knowledge",
                                    "stepMethod": "Theory",
                                    "title": "Course Step "+ (steps+1),
                                    "totalMarks": "100"
                                });
                            }
                        }
                    }

                  //insert into coursestep
                    coursestep.bulk({"docs":defaultCoursestep},function(err,resstep){
                        if(err){
                            console.log(err);
                        }else{
                          for (var i = 0; i < 5; i++) {
                           m_step[0].push(resstep[i].id)
                          }
                          c_step[rescourse[0].id] = m_step[0]
                          for (var b = 5; b <= 5; b++) {
                             m_step[1].push(resstep[b].id)
                          }
                          c_step[rescourse[1].id] = m_step[1]
                          for (var i = 6; i < 8; i++) {
                            m_step[2].push(resstep[i].id)
                          }
                          c_step[rescourse[2].id] = m_step[2]
                          for (var i = 8; i < 11; i++) {
                            m_step[3].push(resstep[i].id)
                          }
                          c_step[rescourse[3].id] = m_step[3]
                           console.log(c_step);
                            for(var steplist = 0; steplist<resstep.length; steplist++){
                                defaultCoursestep[steplist]["_id"] = resstep[steplist].id;
                                defaultCoursestep[steplist]["_rev"] = resstep[steplist].rev;
                                //insert into coursequestion
                                defaultCoursequestion.push({
                                    "CorrectAnswer":  [
                                                           "Charles Babbages",
                                                      ],
                                    "Options": [
                                                   "Sachin Maharjan",
                                                   "Rupesh Manandhar",
                                                   "Charles Babbage",
                                                   "Stefan Unchester"
                                                ],
                                    "Statement": "What is father of computer" +" ?",
                                    "Type": "Multiple Choice",
                                    "courseId": defaultCoursestep[steplist].courseId,
                                    "kind": "coursequestion",
                                    "stepId" : resstep[steplist].id,
                                    "Marks" : 10
                                });
                                defaultCoursequestion.push({
                                        "Statement": "What is programming language"+" ?",
                                        "Type": "Comment/Essay Box",
                                        "courseId": defaultCoursestep[steplist].courseId,
                                        "kind": "coursequestion",
                                        "stepId" : resstep[steplist].id,
                                        "Marks" : 10
                                });

                                defaultCoursequestion.push({
                                    "Statement": "Attach Summer Project" +".",
                                    "Type": "Attachment",
                                    "courseId": defaultCoursestep[steplist].courseId,
                                    "kind": "coursequestion",
                                    "stepId" : resstep[steplist].id,
                                    "Marks" : 10
                                });

                                defaultCoursequestion.push({
                                    "Statement": "Full form of IDE" +".",
                                    "Type": "Single Textbox",
                                    "courseId": defaultCoursestep[steplist].courseId,
                                    "kind": "coursequestion",
                                    "stepId" : resstep[steplist].id,
                                    "Marks" : 10
                                });
                            }

                          coursequestion.bulk({"docs":defaultCoursequestion}, function(err, resquestion) {
                              if (err)
                                  return console.log(err);
                              else {
                                  //need to update questionlist in coursestep
                                  var j = 0;
                                  var k = 4;
                                  for(var i = 0; i < defaultCoursestep.length; i++){
                                      if(i%2==0){
                                          for(j; j < k-3; j++){
                                              defaultCoursestep[i].questionslist.push(resquestion[j].id)
                                          }
                                          j = k;
                                          k = k+4;
                                      }else if(i%3 == 0){
                                           for(j; j < k-2; j++){
                                              defaultCoursestep[i].questionslist.push(resquestion[j].id)
                                          }
                                          j = k;
                                          k = k+4;
                                      } else{
                                          for(j; j < k; j++){
                                              defaultCoursestep[i].questionslist.push(resquestion[j].id)
                                          }
                                          j = k;
                                          k = k+4;
                                      }
                                      coursestep.insert(defaultCoursestep[i], function(err, res) {
                                          if (err)
                                              return console.log(err);
                                      });
                                  }
                              }

                              for (var i = 0; i < resmem.length; i++) {
                                 //insert into Membercourseprogress
                                 for (var j = 4; j > 0; j--) {
                                     defaultMemberprogress.push({
                                     "kind": "course-member-result",
                                     "memberId":resmem[i].id,
                                     "stepsIds": c_step[Object.keys(c_step)[j]],
                                     "stepsResult": [
                                       [
                                           null,
                                           "100"
                                       ],
                                       [
                                           null,
                                           "25",
                                           "50",
                                           "65"
                                       ],
                                       [
                                           null,
                                           "0",
                                           "10"
                                       ],
                                       [
                                           null,
                                           "0"
                                       ],
                                       ""
                                    ],
                                    "stepsStatus": [
                                       [
                                           null,
                                           "1"
                                       ],
                                       [
                                           null,
                                           "1",
                                           "1",
                                           "1"
                                       ],
                                       [
                                           null,
                                           "0",
                                           "0"
                                       ],
                                       [
                                           null,
                                           null
                                       ],
                                       "0"
                                    ],
                                    "pqAttempts": [
                                       1,
                                       3,
                                       2,
                                       1,
                                       0
                                    ],
                                    "courseId": Object.keys(c_step)[j]
                                  });
                                 }
                              }
                              membercourseprogress.bulk({"docs":defaultMemberprogress}, function(err, res) {
                                    if (err)
                                        return console.log(err);
                                      else{
                                        done();
                                      }
                                });
                          });
                        }
                    });
                }
            });
        }
      });
    }
  });
}
function done(){
    console.log("Your Course mock test is ready");
}
start()