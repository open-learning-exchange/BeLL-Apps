$(function(){App.Router=new(Backbone.Router.extend({routes:{updatewelcomevideo:"addOrUpdateWelcomeVideoDoc","":"MemberLogin",dashboard:"Dashboard",ereader:"eReader",login:"MemberLogin",logout:"MemberLogout","member/add":"MemberForm","member/edit/:mid":"MemberForm",resources:"Resources","resource/add":"ResourceForm","resource/edit/:resourceId":"ResourceForm","resource/detail/:rsrcid/:shelfid/:revid":"Resource_Detail","resource/feedback/:resourceId":"ResourceFeedback","resource/feedback/add/:resourceId/:title":"FeedbackForm","resource/search":"bellResourceSearch","search-bell/:levelId/:rId":"SearchBell","assign-to-level":"AssignResourcetoLevel",courses:"Groups","course/manage/:groupId":"ManageCourse","course/details/:courseId/:courseName":"courseDetails","usercourse/details/:courseId/:courseName":"UserCourseDetails","course/report/:groupId/:groupName":"CourseReport","course/assignments/week-of/:groupId/:weekOf":"GroupWeekOfAssignments","course/assignments/:groupId":"GroupAssignments","course/add":"GroupForm","CourseInfo/:courseId":"CourseInfo","course/resign/:courseId":"ResignCourse","course/members/:courseId":"GroupMembers","level/add/:groupId/:levelId/:totalLevels":"AddLevel","level/view/:levelId/:rid":"ViewLevel","savedesc/:lid":"saveDescprition","create-quiz/:lid/:rid/:title":"CreateQuiz",collection:"Collection","listCollection/:collectionId":"ListCollection","listCollection/:collectionId/:collectionName":"ListCollection",meetups:"ListMeetups","meetup/add":"Meetup","meetup/delete/:MeetupId":"deleteMeetUp","usermeetup/detail/:meetupId/:title":"Meetup_Detail","meetup/details/:meetupId/:title":"usermeetupDetails","meetup/manage/:meetUpId":"Meetup","configuration/add":"Configure","search-bell/:publicationId":"SearchPresources",members:"Members",reports:"Reports",trendreport:"trendReport","reports/edit/:resportId":"ReportForm","reports/add":"ReportForm",mail:"email",newsfeed:"NewsFeed",badges:"Badges","courses/barchart":"CoursesBarChart",calendar:"CalendarFunction",addEvent:"addEvent","calendar/event/:eid":"calendaar","calendar-event/edit/:eid":"EditEvent",siteFeedback:"viewAllFeedback",myRequests:"myRequests",AllRequests:"AllRequests",replicateResources:"Replicate",savingPochDB:"PochDB",deletePouchDB:"deletePouchDB","course/invitations/add":"addCourseInvi",compile:"CompileManifest",dbInfo:"dbinfo",weeklyreports:"WeeklyReports",removecache:"UpdateManifest",logreports:"LogQuery",reportsActivity:"LogActivity",setbit:"setNeedOptimizedBit",CompileAppManifest:"CompileAppManifest",communityManage:"communityManage","publications/:community":"Publications"},addOrUpdateWelcomeVideoDoc:function(){var a=new App.Collections.Resources;a.setUrl(App.Server+"/resources/_design/bell/_view/welcomeVideo?include_docs=true"),a.fetch({success:function(){},error:function(){alert("router:: addOrUpdateWelcomeVideoDoc:: error fetching welcome resources")},async:!1});var b;a.length>0&&(b=a.models[0]);var c=b?b:new App.Models.Resource;c.on("processed",function(){Backbone.history.navigate("dashboard",{trigger:!0})});var d=new App.Views.ResourceForm({model:c});d.renderAddOrUploadWelcomeVideoForm(),App.$el.children(".body").html(d.el)},Publications:function(a){var b=new App.Views.PublicationTable;b.render(),App.$el.children(".body").html("<h3>Publications</h3>"),App.$el.children(".body").append(b.el)},communityManage:function(){var a=new App.Views.ManageCommunity;a.render(),App.$el.children(".body").html(a.el)},addCourseInvi:function(){var a=new App.Models.CourseInvitation;a.set("courseId","test"),a.set("userId","test"),a.save(null,{success:function(a,b){console.log(b),alert("success")}});var b=new App.Collections.CourseInvitations;b.courseId="test",b.fetch({async:!1},{success:function(a){console.log(a)}})},initialize:function(){this.bind("all",this.startUpStuff),this.bind("all",this.checkLoggedIn),this.bind("all",this.renderNav)},eReader:function(){this.underConstruction()},Badges:function(){this.underConstruction()},underConstruction:function(){App.$el.children(".body").html('<div style="margin:0 auto"><h4>This Functionality is under Construction</h4></div>')},startUpStuff:function(){0==App.idss.length,$("div.takeQuizDiv").hide(),$("#externalDiv").hide(),$("#invitationdiv").hide(),$("#debug").hide()},renderNav:function(){if($.cookie("Member._id"))var a=new App.Views.navBarView({isLoggedIn:"1"});else var a=new App.Views.navBarView({isLoggedIn:"0"});$("div#nav .container").html(a.el)},checkLoggedIn:function(){if($.cookie("Member._id")){var a=$.cookie("Member.expTime"),b=new Date(Date.parse(a)),c=Math.abs(new Date-b),d=72e5;if(d>c){var e=new Date;$.cookie("Member.expTime",e,{path:"/apps/_design/bell"})}else this.expireSession(),Backbone.history.stop(),App.start()}else"login"!=$.url().attr("fragment")&&""!=$.url().attr("fragment")&&"member/add"!=$.url().attr("fragment")&&(Backbone.history.stop(),App.start())},expireSession:function(){$.removeCookie("Member.login",{path:"/apps/_design/bell"}),$.removeCookie("Member._id",{path:"/apps/_design/bell"}),$.removeCookie("Member.roles",{path:"/apps/_design/bell"}),$.removeCookie("Member.expTime",{path:"/apps/_design/bell"})},Configure:function(){var a=new App.Models.Configuration,b=new App.Views.Configurations({model:a});b.render(),App.$el.children(".body").html(b.el)},MemberLogin:function(){if($.cookie("Member._id"))return void Backbone.history.navigate("dashboard",{trigger:!0});var a=new App.Models.Credentials,b=new App.Views.MemberLoginForm({model:a});b.once("success:login",function(){Backbone.history.navigate("dashboard",{trigger:!0})}),b.render(),App.$el.children(".body").html('<h1 class="login-heading">Member login</h1>'),App.$el.children(".body").append(b.el)},MemberLogout:function(){App.ShelfItems=null,this.expireSession(),Backbone.history.navigate("login",{trigger:!0})},getRoles:function(){var a=new App.Models.Member({_id:$.cookie("Member._id")});a.fetch({async:!1});var b=a.get("roles");return b},Dashboard:function(){App.ShelfItems={},$.ajax({type:"GET",url:'/shelf/_design/bell/_view/DuplicateDetection?include_docs=true&key="'+$.cookie("Member._id")+'"',dataType:"json",success:function(a){for(var b=0;b<a.rows.length;b++)App.ShelfItems[a.rows[b].doc.resourceId]=[a.rows[b].doc.hidden+"+"+a.rows[b].doc.resourceTitle+"+"+a.rows[b].doc._id]},data:{},async:!1});var a=new App.Views.Dashboard;App.$el.children(".body").html(a.el),a.render(),$("#olelogo").remove()},MemberForm:function(a){this.modelForm("Member","Member",a,"login")},modelForm:function(a,b,c,d){var e=new App.Models[a],f=new App.Views[a+"Form"]({model:e});c?(e.id=c,e.fetch({async:!1}),App.$el.children(".body").html("<h3>Edit "+b+" | "+e.get("firstName")+"  "+e.get("lastName")+"</h3>")):App.$el.children(".body").html("<h3>Add "+b+"</h3>"),App.$el.children(".body").append(f.el),e.once("Model:ready",function(){f.on(a+"Form:done",function(){Backbone.history.navigate(d,{trigger:!0})}),f.render(),$(".form .field-startDate input").datepicker({todayHighlight:!0}),$(".form .field-firstName input").attr("maxlength","25"),$(".form .field-lastName input").attr("maxlength","25"),$(".form .field-middleNames input").attr("maxlength","25"),$(".form .field-login input").attr("maxlength","25"),$(".form .field-endDate input").datepicker({todayHighlight:!0}),$(".form .field-startTime input").timepicker({minTime:"8:00am",maxTime:"12:30am"}),$(".form .field-endTime input").timepicker({minTime:"8:00am",maxTime:"12:30am"}),$(".form .field-frequency input").click(function(){"Weekly"==this.value?$(".form .field-Day").show():$(".form .field-Day").hide()})}),c?(e.once("sync",function(){e.trigger("Model:ready")}),e.fetch({async:!1})):e.trigger("Model:ready")},Resources:function(){App.startActivityIndicator();var a,b=$.url().data.attr.host.split(".");b=b[0].substring(3),""==b&&(b="local");var c=this.getRoles(),d=new App.Collections.Resources({skip:0});d.fetch({success:function(){a=new App.Views.ResourcesTable({collection:d}),a.isManager=c.indexOf("Manager");var b='<p style="margin-top:20px"><a class="btn btn-success" href="#resource/add">Add New Resource</a>';b+='<a style="margin-left:10px" class="btn btn-success" onclick=showRequestForm("Resource")>Request Resource</a>',b+='<button style="margin-left:10px;"  class="btn btn-info" onclick="document.location.href=\'#resource/search\'">Search<img width="25" height="0" style="margin-left: 10px;" alt="Search" src="img/mag_glass4.png"></button>',App.$el.children(".body").html(b),App.$el.children(".body").append('<p style="font-size:30px;color:#808080"><a href="#resources"style="font-size:30px;color:#0088CC;text-decoration: underline;">Resources</a>&nbsp&nbsp|&nbsp&nbsp<a href="#collection" style="font-size:30px;">Collections</a></p>'),a.collections=App.collectionslist,a.render(),App.$el.children(".body").append(a.el)}}),App.stopActivityIndicator()},ResourceForm:function(a){var b=this,c=a?new App.Models.Resource({_id:a}):new App.Models.Resource;c.on("processed",function(){Backbone.history.navigate("resources",{trigger:!0})});var d=new App.Views.ResourceForm({model:c});App.$el.children(".body").html(d.el),c.id?(App.listenToOnce(c,"sync",function(){d.render()}),c.fetch({async:!1})):(d.render(),$("input[name='addedBy']").val($.cookie("Member.login"))),$("input[name='addedBy']").attr("disabled",!0),$("select[class='bbf-date']").attr("disabled",!0),$("select[class='bbf-month']").attr("disabled",!0),$("select[class='bbf-year']").attr("disabled",!0),$(".form .field-subject select").attr("multiple",!0),$(".form .field-subject select").multiselect().multiselectfilter(),$(".form .field-Level select").attr("multiple",!0),$(".form .field-Level select").multiselect().multiselectfilter(),void 0==c.id&&($(".form .field-Level select").multiselect("uncheckAll"),$(".form .field-subject select").multiselect("uncheckAll")),$(".form .field-Tag select").attr("multiple",!0),$(".form .field-Tag select").click(function(){b.AddNewSelect(this.value)}),$(".form .field-Tag select").dblclick(function(){b.EditTag(this.value)});var e=".form .field-Tag select";if(this.RenderTagSelect(e),$(".form .field-Tag select").multiselect().multiselectfilter(),$(".form .field-Tag select").multiselect("uncheckAll"),c.id){if($(".form .field-subject select").multiselect("refresh"),c.get("Tag")){for(var f=c.get("Tag").length,g=0;f>g;g++)$('.form .field-Tag select option[value="'+c.get("Tag")[g]+'"]').attr("selected","selected");$(".form .field-Tag select").multiselect("refresh")}null==c.get("subject")&&$(".form .field-subject select").find("option").removeAttr("selected"),null==c.get("Tag")&&$(".form .field-Tag select").find("option").removeAttr("selected"),null==c.get("Level")&&$(".form .field-Level select").find("option").removeAttr("selected")}},bellResourceSearch:function(){popAll();var a=new App.Views.Search;a.addResource=!1,a.render(),App.$el.children(".body").html(a.el),$("#multiselect-collections-search").multiselect().multiselectfilter(),$("#multiselect-levels-search").multiselect().multiselectfilter(),$("#multiselect-medium-search").multiselect({multiple:!1,header:"Select an option",noneSelectedText:"Select an Option",selectedList:1}),$("#search-language").multiselect({multiple:!1,header:"Select an option",noneSelectedText:"Select an Option",selectedList:1}),$("#srch").hide(),$(".search-bottom-nav").hide(),$(".search-result-header").hide(),$("#selectAllButton").hide(),showSubjectCheckBoxes(),$("#multiselect-subject-search").multiselect().multiselectfilter()},SearchBell:function(a,b,c){var d=new App.Models.CourseStep({_id:a});d.fetch({success:function(){"undefined"==typeof a&&(document.location.href="#courses"),"undefined"==typeof b&&(document.location.href="#courses"),grpId=a,levelrevId=b,ratingFilter.length=0,rtitle.length=0,rids.length=0;var c=new App.Views.Search;c.resourceids=d.get("resourceId"),c.addResource=!0,c.render(),App.$el.children(".body").html(c.el),$("#multiselect-collections-search").multiselect().multiselectfilter(),$("#multiselect-levels-search").multiselect().multiselectfilter(),$("#multiselect-medium-search").multiselect({multiple:!1,header:"Select an option",noneSelectedText:"Select an Option",selectedList:1}),$("#search-language").multiselect({multiple:!1,header:"Select an option",noneSelectedText:"Select an Option",selectedList:1}),$("#srch").hide(),$(".search-bottom-nav").hide(),$(".search-result-header").hide(),$("#selectAllButton").hide(),showSubjectCheckBoxes(),$("#multiselect-subject-search").multiselect().multiselectfilter()}})},AssignResourcetoLevel:function(){"undefined"==typeof grpId&&(document.location.href="#courses");var a=new App.Models.CourseStep({_id:grpId});a.fetch({async:!1});var b=a.get("resourceId"),c=a.get("resourceTitles");$("input[name='result']").each(function(){if($(this).is(":checked")){var a=$(this).val();-1==b.indexOf(a)&&(rtitle.push($(this).attr("rTitle")),rids.push(a))}}),a.set("resourceId",b.concat(rids)),a.set("resourceTitles",c.concat(rtitle)),a.save(null,{success:function(b,c){a.set("_rev",c.rev),alert("Your Resources have been updated successfully"),Backbone.history.navigate("level/view/"+c.id+"/"+c.rev,{trigger:!0})}})},SearchPresources:function(a){var b=new App.Models.Publication({_id:a});b.fetch({success:function(){var b=new App.Views.Search;grpId=a,b.addResource=!0,b.Publications=!0,App.$el.children(".body").html(b.el),b.render(),$("#multiselect-collections-search").multiselect().multiselectfilter(),$("#multiselect-levels-search").multiselect().multiselectfilter(),$("#multiselect-medium-search").multiselect({multiple:!1,header:"Select an option",noneSelectedText:"Select an Option",selectedList:1}),$("#search-language").multiselect({multiple:!1,header:"Select an option",noneSelectedText:"Select an Option",selectedList:1}),$("#srch").hide(),$(".search-bottom-nav").hide(),$(".search-result-header").hide(),$("#selectAllButton").hide(),showSubjectCheckBoxes(),$("#multiselect-subject-search").multiselect().multiselectfilter()},async:!1})},Groups:function(){App.startActivityIndicator(),groups=new App.Collections.Groups,groups.fetch({success:function(){groupsTable=new App.Views.GroupsTable({collection:groups}),groupsTable.render();var a='<p id="library-top-buttons">';a+='<a class="btn btn-success" style="width: 110px"; href="#course/add">Add Course</a>',a+='<a style="margin-left:10px" class="btn btn-success" onclick=showRequestForm("Course")>Request Course</a>',a+='<span style="float:right"><input id="searchText"  placeholder="Search" value="" size="30" style="height:24px;margin-top:1%;" type="text"><span style="margin-left:10px">',a+='<button class="btn btn-info" onclick="CourseSearch()">Search</button></span>',a+="</p>",App.$el.children(".body").html(a),App.$el.children(".body").append("<h3>Courses</h3>"),App.$el.children(".body").append(groupsTable.el)}}),App.stopActivityIndicator()},CreateQuiz:function(a,b,c){var d=new App.Models.CourseStep({_id:a});d.fetch({success:function(){var b=new App.Views.QuizView;b.levelId=a,b.revId=d.get("_rev"),b.ltitle=c,d.get("questions")&&(App.$el.children(".body").html("<h3>Edit Quiz for |"+c+"</h3>"),b.quizQuestions=d.get("questions"),b.questionOptions=d.get("qoptions"),b.answers=d.get("answers")),App.$el.children(".body").html(b.el),b.render(),d.get("questions")&&b.displayQuestionsInView()}})},CourseInfo:function(a){var b=new App.Models.Group;b.set("_id",a),b.fetch({async:!1});var c=b.get("courseLeader"),d=new App.Models.Member;d.set("_id",c),d.fetch({async:!1});var e=new App.Views.CourseInfoView({model:b});e.leader=d,e.render(),App.$el.children(".body").html("&nbsp"),App.$el.children(".body").append('<div class="courseInfo-header"><a href="#usercourse/details/'+a+"/"+b.get("name")+'"><button type="button" class="btn btn-info" id="back">Back</button></a>&nbsp;&nbsp;&nbsp;&nbsp<a href="#course/resign/'+a+'"><button id="resignCourse" class="btn resignBtn btn-danger" value="0">Resign</button></a>&nbsp;&nbsp;</div>'),App.$el.children(".body").append(e.el)},CourseReport:function(a,b){var c=this.getRoles(),d=new App.Models.Group;d.id=a,d.fetch({async:!1}),App.$el.children(".body").html("<h2> "+b+"</h2>"),(void 0!=d.get("courseLeader")&&d.get("courseLeader")==$.cookie("Member._id")||-1!=c.indexOf("Manager"))&&App.$el.children(".body").append('<button class="btn btn-success" style="margin-left:784px;margin-top:-74px"  onclick = "document.location.href=\'#course/manage/'+a+"'\">Manage</button>"),App.$el.children(".body").append("<div id='graph'></div>");var e=new App.Collections.StepResultsbyCourse;d.get("courseLeader")!=$.cookie("Member._id")&&-1==c.indexOf("Manager")&&(e.memberId=$.cookie("Member._id")),e.courseId=a,e.fetch({async:!1});var f=new App.Views.CoursesStudentsProgress({collection:e});f.render(),App.$el.children(".body").append(f.el)},ManageCourse:function(a){var b=this;levels=new App.Collections.CourseLevels,levels.groupId=a;var c="Group",d=new App.Models[c],e=new App.Views[c+"Form"]({model:d});App.$el.children(".body").html("<br/>"),App.$el.children(".body").append("<h3>Course Manage</h3>"),App.$el.children(".body").append(e.el),d.once("Model:ready",function(){e.on(c+"Form:done",function(){Backbone.history.navigate(reroute,{trigger:!0})}),e.render(),$(".form .field-startDate input").datepicker({todayHighlight:!0}),$(".form .field-endDate input").datepicker({todayHighlight:!0}),$(".form .field-startTime input").timepicker({minTime:"8:00am",maxTime:"12:30am"}),$(".form .field-endTime input").timepicker({minTime:"8:00am",maxTime:"12:30am"});var a=b.getRoles();-1==a.indexOf("Manager")&&$(".form .field-courseLeader select").attr("disabled","true"),$(".form .field-frequency input").click(function(){"Weekly"==this.value?$(".form .field-Day").show():$(".form .field-Day").hide()})}),a?(d.id=a,d.once("sync",function(){d.trigger("Model:ready")}),d.fetch()):d.trigger("Model:ready"),levels.fetch({success:function(){levels.sort(),lTable=new App.Views.LevelsTable({collection:levels}),lTable.groupId=a,lTable.render(),App.$el.children(".body").append("</BR><h3> Course Steps </h3>"),App.$el.children(".body").append(lTable.el),$("#moveup").hide(),$("#movedown").hide(),$("input[type='radio']").hide()}})},courseDetails:function(a,b){var c=new App.Models.Group({_id:a});c.fetch({async:!1});var d=c.get("courseLeader"),b=c.get("name"),e=c.get("members"),f='<br><a href="#courses"><button class="btn btn-success">Back to courses</button></a>';f+=e&&-1==e.indexOf($.cookie("Member._id"))?'&nbsp;&nbsp;<button class="btn btn-danger" id="admissionButton" onClick=sendAdminRequest("'+d+'","'+encodeURI(b)+'","'+a+'")>Admission</button><br/><br/>':"<br/><br/>",App.$el.children(".body").html('<div id="courseName-heading"><h3>Course Details | '+b+"</h3></div>"),App.$el.children(".body").append(f);var g=new App.Models.Member;g.set("_id",d),g.fetch({async:!1});var h=new App.Collections.coursesteps;h.courseId=a,h.fetch({async:!1});var i=new App.Views.GroupView({model:c});i.courseLeader=g,i.render();var j=new App.Views.CourseStepsView({collection:h});j.render(),App.$el.children(".body").append(i.el),App.$el.children(".body").append('<div id="courseSteps-heading"><h5>Course Steps</h5></div>'),App.$el.children(".body").append(j.el),$("#admissionButton").on("click",function(a){$(document).trigger("Notification:submitButtonClicked")})},UserCourseDetails:function(a,b){var c=new App.Collections.coursesteps;c.courseId=a,c.fetch({success:function(){App.$el.children(".body").html("&nbsp"),App.$el.children(".body").append('<p class="Course-heading">Course<b>|</b>'+b+'    <a href="#CourseInfo/'+a+'"><button class="btn fui-eye"></button></a><a id="showBCourseMembers" style="float:right;margin-right:10%" href="#course/members/'+a+'" style="margin-left:10px" class="btn btn-info">Course Members</a> </p>');var d=new App.Views.CourseLevelsTable({collection:c});d.courseId=a,d.render(),App.$el.children(".body").append(d.el)}})},GroupMembers:function(a){var b=new App.Views.GroupMembers;b.courseId=a,b.render(),App.$el.children(".body").html(b.el)},GroupForm:function(a){this.modelForm("Group","Course",a,"courses")},GroupAssign:function(a){var b=new App.Views.AssignResourcesToGroupTable;b.groupId=a,b.render(),App.$el.children(".body").html(b.el)},ResignCourse:function(a){var b=$.cookie("Member._id"),c=new App.Models.Group;c.set("_id",a),c.fetch({async:!1});var d=c.get("members"),e=d.indexOf(b);d.splice(e,1),c.set({members:d}),c.save();var f=new App.Collections.memberprogressallcourses;f.memberId=b,f.fetch({async:!1}),f.each(function(b){b.get("courseId")==a&&b.destroy()});var g=new App.Models.Mail,h=new Date,i=c.get("courseLeader"),j="Course Resignation | "+c.get("name"),k="Hi,<br>Member "+$.cookie("Member.login")+" has resign from "+c.get("name");g.set("senderId",$.cookie("Member._id")),g.set("receiverId",i),g.set("subject",j),g.set("body",k),g.set("status","0"),g.set("type","mail"),g.set("sentDate",h),g.save(),alert("Successfully resigned from "+c.get("name")+" . "),Backbone.history.navigate("dashboard",{trigger:!0})},GroupWeekOfAssignments:function(a,b){b||(b=moment().subtract("days",moment().format("d")).format("YYYY-MM-DD"));var c=b,d=moment(b).add("days",7).format("YYYY-MM-DD"),e=new App.Views.AssignWeekOfResourcesToGroupTable;App.$el.children(".body").html(e.el),e.group=new App.Models.Group,e.group.id=a,e.resources=new App.Collections.Resources,e.assignments=new App.Collections.GroupAssignmentsByDate,e.assignments.groupId=a,e.assignments.startDate=c,e.assignments.endDate=d,e.weekOf=b,e.resources.on("sync",function(){e.assignments.fetch()}),e.assignments.on("sync",function(){e.group.fetch()}),e.group.on("sync",function(){e.render()}),e.resources.fetch()},AddLevel:function(a,b,c){var d=new App.Models.CourseStep;d.set({courseId:a});var e=new App.Views.LevelForm({model:d});if("nolevel"==b?(App.$el.children(".body").html("<h3>New Step</h3>"),e.edit=!1,e.previousStep=0,e.render(),App.$el.children(".body").append(e.el),$("input[name='step']").attr("disabled",!0)):(d.set({_id:b}),d.once("sync",function(){App.$el.children(".body").html("<h3>Edit Step</h3>"),e.edit=!0,e.ques=d.get("questions"),e.ans=d.get("answers"),e.opt=d.get("qoptions"),e.res=d.get("resourceId"),e.rest=d.get("resourceTitles"),e.previousStep=d.get("step"),e.render(),App.$el.children(".body").append(e.el),$("input[name='step']").attr("disabled",!0)}),d.fetch()),-1!=c){var f=parseInt(c)+1;$("input[name='step']").val(f)}},ViewLevel:function(a,b){var c=new App.Models.CourseStep({_id:a});c.fetch({success:function(){var d=new App.Views.LevelDetail({model:c});d.render(),App.$el.children(".body").html("<h3> Step "+c.get("step")+" | "+c.get("title")+"</h3>"),App.$el.children(".body").append('<a class="btn btn-success" href=\'#level/add/'+c.get("courseId")+"/"+a+"/-1'\">Edit Step</a>&nbsp;&nbsp;"),App.$el.children(".body").append("<a class='btn btn-success' href='#course/manage/"+c.get("courseId")+"'>Back To Course </a>&nbsp;&nbsp;"),App.$el.children(".body").append("</BR></BR><B>Description</B></BR><TextArea id='LevelDescription' rows='5' cols='100' style='width:98%;'>"+c.get("description")+"</TextArea></BR>"),App.$el.children(".body").append("<button class='btn btn-success' style='float:right;' onclick='document.location.href=\"#savedesc/"+a+"\"'>Save</button></BR></BR>"),App.$el.children(".body").append('<B>Resources</B>&nbsp;&nbsp;<a class="btn btn-success"  style="" href=\'#search-bell/'+a+"/"+b+"'\">Add</a>"),App.$el.children(".body").append(d.el),App.$el.children(".body").append("</BR>"),null==c.get("questions")?App.$el.children(".body").append('<a class="btn btn-success"  style="float:right;"  href=\'#create-quiz/'+c.get("_id")+"/"+c.get("_rev")+"/"+c.get("title")+"'\">Create Quiz</a>&nbsp;&nbsp;"):App.$el.children(".body").append("<B>"+c.get("title")+' - Quiz</B><a class="btn btn-primary"  style="float:right;" href=\'#create-quiz/'+c.get("_id")+"/"+c.get("_rev")+"/"+c.get("title")+"'\">Edit Quiz</a>&nbsp;&nbsp;")}})},saveDescprition:function(a){var b=new App.Models.CourseStep({_id:a});b.fetch({success:function(){b.set("description",$("#LevelDescription").val());b.save(),b.on("sync",function(){document.location.href="#level/view/"+a+"/"+b.get("rev")})}})},GroupSearch:function(){var a;a=new App.Views.CourseSearch,a.render();var b='<p style="margin-top:15px">';b+='<a class="btn btn-success" href="#course/add">Add a new Cource</a>',b+='<a style="margin-left:10px" class="btn btn-success" onclick=showRequestForm("Course")>Request Course</a>',b+='<a style="margin-left:10px" class="btn btn-info" onclick="ListAllCourses()">View All Courses</a>',b+='<span style="float:right">Keyword:&nbsp;<input id="searchText"  placeholder="Search" value="" size="30" style="height:24px;margin-top:1%;" type="text"><span style="margin-left:10px">',b+='<button class="btn btn-info" onclick="CourseSearch()">Search</button></span>',b+="</p>",App.$el.children(".body").html(b),App.$el.children(".body").append("<h3>Courses</h3>"),App.$el.children(".body").append(a.el)},ListMeetups:function(){App.$el.children(".body").html('<h3>Meetups<a style="margin-left:20px" class="btn btn-success" href="#meetup/add">Add Meetup</a></h3>');var a=new App.Collections.Meetups;a.fetch({async:!1});var b=new App.Views.MeetUpTable({collection:a});b.render(),App.$el.children(".body").append(b.el)},Meetup_Detail:function(a,b){var c=new App.Models.MeetUp({_id:a});c.fetch({async:!1});var d=new App.Views.MeetupDetails({model:c});d.render(),App.$el.children(".body").html(d.el)},usermeetupDetails:function(a,b){var c=new App.Models.MeetUp({_id:a});c.fetch({async:!1});var d=new App.Views.meetupView({model:c});d.render(),App.$el.children(".body").html(d.el)},Meetup:function(a){var b="MeetUp",c=new App.Models[b];a&&(c.id=a,c.fetch({async:!1}));var d=new App.Views[b+"Form"]({model:c});d.render(),App.$el.children(".body").html(d.el),$(".form .field-startTime input").timepicker({minTime:"8:00am",maxTime:"12:30am"}),$(".form .field-endTime input").timepicker({minTime:"8:00am",maxTime:"12:30am"}),$(".form .field-startDate input").datepicker({todayHighlight:!0}),$(".form .field-endDate input").datepicker({todayHighlight:!0}),$(".form .field-reoccuring input").click(function(){"Weekly"==this.value?$(".form .field-Day").show():$(".form .field-Day").hide()})},deleteMeetUp:function(a){var b=new App.Collections.UserMeetups;b.meetupId=a,b.fetch({async:!1});for(var c;c=b.first();)c.destroy();var d=new App.Models.MeetUp({_id:a});d.fetch({async:!1}),d.destroy(),Backbone.history.navigate("meetups",{trigger:!0})},Members:function(){var a=new App.Views.MembersView;a.render(),App.$el.children(".body").html(a.el)},Reports:function(){App.startActivityIndicator();var a=this.getRoles(),b=new App.Collections.Reports;b.fetch({async:!1});var c=new App.Views.ReportsTable({collection:b});c.isManager=a.indexOf("Manager"),c.render(),App.$el.children(".body").html(""),a.indexOf("Manager")>-1?App.$el.children(".body").append('<p style="margin-top:10px"><a class="btn btn-success" href="#reports/add">Add a new Report</a><a style="margin-left:20px" class="btn btn-success" href="#logreports">Activity Report</a><a style="margin-left:20px" class="btn btn-success" href="#trendreport">Trend Activity Report</a></p>'):App.$el.children(".body").append('<p style="margin-top:10px;margin-left:10px;"><a class="btn btn-success" href="#logreports">Activity Report</a></p>');var d=$.url().attr("host").split(".");d=d[0].substring(3),0==d.length&&(d="Community"),App.$el.children(".body").append('<h4><span style="color:gray;">'+d+"</span> | Reports</h4>"),App.$el.children(".body").append(c.el),App.stopActivityIndicator()},turnDateToYYYYMMDDFormat:function(a){var b=a.getFullYear().toString(),c=(a.getMonth()+1).toString(),d=a.getDate().toString(),e=c.split(""),f=d.split(""),g=b+"/"+(2===e.length?c:"0"+e[0])+"/"+(2===f.length?d:"0"+f[0]);return g},aggregateDataForTrendReport:function(a,b){if(b.length<1){var c={Visits:{male:0,female:0},New_Signups:{male:0,female:0},Deleted:{male:0,female:0},Most_Freq_Open:[],Highest_Rated:[],Lowest_Rated:[],ResourceViews:{male:0,female:0}};return c}var d=b[0];void 0==d&&alert("No Activity Logged for this period");var e=[],f=[],g=[],h=0,i=0,j=0,k=0,l=[],m=[],n=[],o=[],p=[],q=[],r=0,s=0;d.resourcesIds&&(e=d.resourcesIds),d.resources_names&&(g=d.resources_names),d.resources_opened&&(f=d.resources_opened),d.male_visits&&(h=d.male_visits),d.female_visits&&(i=d.female_visits),d.male_new_signups&&(j=d.male_new_signups),d.female_new_signups&&(k=d.female_new_signups),d.male_rating&&(l=d.male_rating),d.female_rating&&(m=d.female_rating),d.male_timesRated&&(n=d.male_timesRated),d.female_timesRated&&(o=d.female_timesRated),d.male_opened&&(p=d.male_opened),d.female_opened&&(q=d.female_opened),d.male_deleted_count&&(s=d.male_deleted_count),d.female_deleted_count&&(r=d.female_deleted_count);for(var t=0;t<b.length;t++)if(t>0){var u=b[t];h+=u.male_visits,i+=u.female_visits,j+=u.male_new_signups?u.male_new_signups:0,k+=u.female_new_signups?u.female_new_signups:0,r+=u.female_deleted_count?u.female_deleted_count:0,s+=u.male_deleted_count?u.male_deleted_count:0;for(var v=u.resourcesIds,w=u.resources_names,x=u.resources_opened,y=0;y<v.length;y++){var z=v[y],A=e.indexOf(z);-1==A?(e.push(z),l.push(u.male_rating[y]),m.push(u.female_rating[y]),n.push(u.male_timesRated[y]),o.push(u.female_timesRated[y])):(l[A]=l[A]+u.male_rating[y],m[A]=m[A]+u.female_rating[y],n[A]=n[A]+u.male_timesRated[y],o[A]=o[A]+u.female_timesRated[y])}if(x)for(var y=0;y<x.length;y++){var z=x[y],A=f.indexOf(z);-1==A?(f.push(z),void 0!=w&&null!=w&&w.length>0&&g.push(w[y]),p.push(u.male_opened[y]),q.push(u.female_opened[y])):(p[A]=p[A]+u.male_opened[y],q[A]=q[A]+u.female_opened[y])}}for(var B=0,y=0;y<q.length;y++)B+=q[y];for(var C=0,y=0;y<p.length;y++)C+=p[y];for(var D=[],E=[],y=0;y<f.length;y++)D.push(p[y]+q[y]);var F=[],G=5;F=D.length>=G?this.findIndicesOfMax(D,G):this.findIndicesOfMax(D,D.length);var H,I;if(D.length>0)for(var J,K,y=0;y<F.length;y++){var L=new App.Models.Resource({_id:f[F[y]]});L.fetch({async:!1});var M=L.get("title");J={resourceName:M,timesOpenedCumulative:D[F[y]],timesOpenedByMales:p[F[y]],timesOpenedByFemales:q[F[y]]},-1===(K=e.indexOf(f[F[y]]))?(J.avgRatingCumulative="N/A",J.avgRatingByMales="N/A",J.avgRatingByFemales="N/A",J.timesRatedByMales="N/A",J.timesRatedByFemales="N/A",J.timesRatedCumulative="N/A"):(H=n[K]+o[K],I=l[K]+m[K],J.avgRatingCumulative=Math.round(I/H*100)/100,J.avgRatingByMales=l[K],J.avgRatingByFemales=m[K],J.timesRatedByMales=n[K],J.timesRatedByFemales=o[K],J.timesRatedCumulative=H),E.push(J)}for(var N=[],O=[],P=[],Q=5,y=0;y<e.length;y++)H=n[y]+o[y],I=l[y]+m[y],N.push(I/H);var R=[],S=[];if(N.length>=G?(R=this.findIndicesOfMax(N,G),S=this.findIndicesOfMin(N,Q)):(R=this.findIndicesOfMax(N,N.length),S=this.findIndicesOfMin(N,N.length)),N.length>0){for(var T,U,y=0;y<R.length;y++){var L=new App.Models.Resource({_id:e[R[y]]});L.fetch({async:!1});var M=L.get("title");H=n[R[y]]+o[R[y]],T={resourceName:M,avgRatingCumulative:Math.round(100*N[R[y]])/100,avgRatingByMales:l[R[y]],avgRatingByFemales:m[R[y]],timesRatedByMales:n[R[y]],timesRatedByFemales:o[R[y]],timesRatedCumulative:n[R[y]]+o[R[y]]},-1===(K=f.indexOf(e[R[y]]))?(T.timesOpenedByMales="N/A",T.timesOpenedByFemales="N/A",T.timesOpenedCumulative="N/A"):(T.timesOpenedByMales=p[K],T.timesOpenedByFemales=q[K],T.timesOpenedCumulative=D[K]),O.push(T)}for(var y=0;y<S.length;y++){H=n[S[y]]+o[S[y]];var L=new App.Models.Resource({_id:e[S[y]]});L.fetch({async:!1});var M=L.get("title");U={resourceName:M,avgRatingCumulative:Math.round(100*N[S[y]])/100,avgRatingByMales:l[S[y]],avgRatingByFemales:m[S[y]],timesRatedByMales:n[S[y]],timesRatedByFemales:o[S[y]],timesRatedCumulative:n[S[y]]+o[S[y]]},-1===(K=f.indexOf(e[S[y]]))?(U.timesOpenedByMales="N/A",U.timesOpenedByFemales="N/A",U.timesOpenedCumulative="N/A"):(U.timesOpenedByMales=p[K],U.timesOpenedByFemales=q[K],U.timesOpenedCumulative=D[K]),P.push(U)}}var c={Visits:{male:h,female:i},New_Signups:{male:j,female:k},Deleted:{male:s,female:r},Most_Freq_Open:E,Highest_Rated:O,Lowest_Rated:P,ResourceViews:{male:C,female:B}};return c},turnDateFromMMDDYYYYToYYYYMMDDFormat:function(a){
var b=a.match(/\d+/g),c=b[0],d=b[1],e=b[2];return e+"/"+c+"/"+d},getRegisteredMembersCount:function(a){var b=0,c=0;$.ajax({url:'/activitylog/_design/bell/_view/GetMaleCountByCommunity?key="'+App.configuration.get("code")+'"',type:"GET",dataType:"json",async:!1,success:function(d){d.rows[0]&&(b=d.rows[0].value),$.ajax({url:'/activitylog/_design/bell/_view/GetFemaleCountByCommunity?key="'+App.configuration.get("code")+'"',type:"GET",dataType:"json",async:!1,success:function(d){d.rows[0]&&(c=d.rows[0].value),a(b,c)}})}})},getRegisteredMembersCountFromMembersDB:function(a){var b=0,c=0;$.ajax({url:'/members/_design/bell/_view/MaleCountByCommunity?key="'+App.configuration.get("code")+'"',type:"GET",dataType:"json",async:!1,success:function(d){d.rows[0]&&(b=d.rows[0].value),$.ajax({url:'/members/_design/bell/_view/FemaleCountByCommunity?key="'+App.configuration.get("code")+'"',type:"GET",dataType:"json",async:!1,success:function(d){d.rows[0]&&(c=d.rows[0].value),a(b,c)}})}})},getTotalMemberVisits:function(a){var b=0,c=0;$.ajax({url:'/activitylog/_design/bell/_view/GetMaleVisitsByCommunity?key="'+App.configuration.get("code")+'"',type:"GET",dataType:"json",async:!1,success:function(d){d.rows[0]&&(b=d.rows[0].value),$.ajax({url:'/activitylog/_design/bell/_view/GetFemaleVisitsByCommunity?key="'+App.configuration.get("code")+'"',type:"GET",dataType:"json",async:!1,success:function(d){d.rows[0]&&(c=d.rows[0].value),a(b,c)}})}})},trendReport:function(){var a=this;App.$el.children(".body").html(""),$('<div id="trend-report-form"></div>').appendTo(App.$el.children(".body"));var b=$("<label>").text("Trend report ending: ");$("#trend-report-form").append(b);var c=new Date,d=$('<input type="text">').attr({id:"dateSelect",name:"dateSelect",value:c.getFullYear().toString()+"-"+(c.getMonth()<9?"0"+(c.getMonth()+1):c.getMonth()+1)+"-"+(c.getDate()<9?"0"+c.getDate():c.getDate())});d.width(85),d.appendTo(b),$("#dateSelect").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});var e=$('<input type="button">').attr({id:"submit",name:"submit","class":"btn btn-success",value:"Generate Report"});$("#trend-report-form").append(e),e.click(function(){var b=$("#dateSelect").val();if(b){var c=$("#dateSelect").datepicker("getDate"),d=new Date(c.getFullYear(),c.getMonth(),1),e=new Date(d.getFullYear(),d.getMonth(),d.getDate()-1),f=new Date(e.getFullYear(),e.getMonth(),1),g=new Date(f.getFullYear(),f.getMonth(),f.getDate()-1),h=new Date(g.getFullYear(),g.getMonth(),1),i=new Date(h.getFullYear(),h.getMonth(),h.getDate()-1),j=new Date(i.getFullYear(),i.getMonth(),1),k=new Date(j.getFullYear(),j.getMonth(),j.getDate()-1),l=new Date(k.getFullYear(),k.getMonth(),1),m=new Date(l.getFullYear(),l.getMonth(),l.getDate()-1),n=new Date(m.getFullYear(),m.getMonth(),1),o=new Date(n.getFullYear(),n.getMonth(),n.getDate()-1),p=new Date(o.getFullYear(),o.getMonth(),1),q=new Date(p.getFullYear(),p.getMonth(),p.getDate()-1),r=new Date(q.getFullYear(),q.getMonth(),1),s=new Date(r.getFullYear(),r.getMonth(),r.getDate()-1),t=new Date(s.getFullYear(),s.getMonth(),1),u=new Date(t.getFullYear(),t.getMonth(),t.getDate()-1),v=new Date(u.getFullYear(),u.getMonth(),1),w=new Date(v.getFullYear(),v.getMonth(),l.getDate()-1),x=new Date(w.getFullYear(),w.getMonth(),1),y=new Date(x.getFullYear(),x.getMonth(),x.getDate()-1),z=new Date(y.getFullYear(),y.getMonth(),1),A=a.changeDateFormat(a.turnDateToYYYYMMDDFormat(z)),B=a.changeDateFormat(a.turnDateToYYYYMMDDFormat(c)),C=new App.Collections.ActivityLog,D=App.Server+'/activitylog/_design/bell/_view/getDocByCommunityCode?include_docs=true&startkey=["'+App.configuration.get("code")+'","'+A+'"]&endkey=["'+App.configuration.get("code")+'","'+B+'"]';C.setUrl(D),C.fetch({async:!1}),C.toJSON();var E=[],F=[],G=[],H=[],I=[],J=[],K=[],L=[],M=[],N=[],O=[],P=[];for(var Q in C.models){var R=a.turnDateFromMMDDYYYYToYYYYMMDDFormat(C.models[Q].get("logDate"));a.turnDateToYYYYMMDDFormat(d),a.turnDateToYYYYMMDDFormat(c);R>=a.turnDateToYYYYMMDDFormat(d)&&R<=a.turnDateToYYYYMMDDFormat(c)?E.push(JSON.parse(JSON.stringify(C.models[Q]))):R>=a.turnDateToYYYYMMDDFormat(f)&&R<=a.turnDateToYYYYMMDDFormat(e)?F.push(JSON.parse(JSON.stringify(C.models[Q]))):R>=a.turnDateToYYYYMMDDFormat(h)&&R<=a.turnDateToYYYYMMDDFormat(g)?G.push(JSON.parse(JSON.stringify(C.models[Q]))):R>=a.turnDateToYYYYMMDDFormat(j)&&R<=a.turnDateToYYYYMMDDFormat(i)?H.push(JSON.parse(JSON.stringify(C.models[Q]))):R>=a.turnDateToYYYYMMDDFormat(l)&&R<=a.turnDateToYYYYMMDDFormat(k)?I.push(JSON.parse(JSON.stringify(C.models[Q]))):R>=a.turnDateToYYYYMMDDFormat(n)&&R<=a.turnDateToYYYYMMDDFormat(m)?J.push(JSON.parse(JSON.stringify(C.models[Q]))):R>=a.turnDateToYYYYMMDDFormat(p)&&R<=a.turnDateToYYYYMMDDFormat(o)?K.push(JSON.parse(JSON.stringify(C.models[Q]))):R>=a.turnDateToYYYYMMDDFormat(r)&&R<=a.turnDateToYYYYMMDDFormat(q)?L.push(JSON.parse(JSON.stringify(C.models[Q]))):R>=a.turnDateToYYYYMMDDFormat(t)&&R<=a.turnDateToYYYYMMDDFormat(s)?M.push(JSON.parse(JSON.stringify(C.models[Q]))):R>=a.turnDateToYYYYMMDDFormat(v)&&R<=a.turnDateToYYYYMMDDFormat(u)?N.push(JSON.parse(JSON.stringify(C.models[Q]))):R>=a.turnDateToYYYYMMDDFormat(x)&&R<=a.turnDateToYYYYMMDDFormat(w)?O.push(JSON.parse(JSON.stringify(C.models[Q]))):R>=a.turnDateToYYYYMMDDFormat(z)&&R<=a.turnDateToYYYYMMDDFormat(y)&&P.push(JSON.parse(JSON.stringify(C.models[Q])))}var S=a.aggregateDataForTrendReport("communityX",E),T=a.aggregateDataForTrendReport("communityX",F),U=a.aggregateDataForTrendReport("communityX",G),V=a.aggregateDataForTrendReport("communityX",H),W=a.aggregateDataForTrendReport("communityX",I),X=a.aggregateDataForTrendReport("communityX",J),Y=a.aggregateDataForTrendReport("communityX",K),Z=a.aggregateDataForTrendReport("communityX",L),_=a.aggregateDataForTrendReport("communityX",M),aa=a.aggregateDataForTrendReport("communityX",N),ba=a.aggregateDataForTrendReport("communityX",O),ca=a.aggregateDataForTrendReport("communityX",P),da=a.aggregateDataForTrendReport("communityX",JSON.parse(JSON.stringify(C.models)));console.log(S);var ea=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],fa={male:0,female:0};a.getRegisteredMembersCount(function(a,b){fa.male=a,fa.female=b});var ga={male:0,female:0};a.getRegisteredMembersCountFromMembersDB(function(a,b){ga.male=a,ga.female=b});var ha={male:0,female:0};a.getTotalMemberVisits(function(a,b){ha.male=a,ha.female=b});var ia={male:fa.male,female:fa.female,total:0},ja={male:fa.male-S.New_Signups.male,female:fa.female-S.New_Signups.female,total:0},ka={male:ja.male-T.New_Signups.male,female:ja.female-T.New_Signups.female,total:0},la={male:ka.male-U.New_Signups.male,female:ka.female-U.New_Signups.female,total:0},ma={male:la.male-V.New_Signups.male,female:la.female-V.New_Signups.female,total:0},na={male:ma.male-W.New_Signups.male,female:ma.female-W.New_Signups.female,total:0},oa={male:na.male-X.New_Signups.male,female:na.female-X.New_Signups.female,total:0},pa={male:oa.male-Y.New_Signups.male,female:oa.female-Y.New_Signups.female,total:0},qa={male:pa.male-Z.New_Signups.male,female:pa.female-Z.New_Signups.female,total:0},ra={male:qa.male-_.New_Signups.male,female:qa.female-_.New_Signups.female,total:0},sa={male:ra.male-aa.New_Signups.male,female:ra.female-aa.New_Signups.female,total:0},ta={male:sa.male-ba.New_Signups.male,female:sa.female-ba.New_Signups.female,total:0};ia.total=ia.male+ia.female,ja.total=ja.male+ja.female,ka.total=ka.male+ka.female,la.total=la.male+la.female,ma.total=ma.male+ma.female,na.total=na.male+na.female,oa.total=oa.male+oa.female,pa.total=pa.male+pa.female,qa.total=qa.male+qa.female,ra.total=ra.male+ra.female,sa.total=sa.male+sa.female,ta.total=ta.male+ta.female;var ua={male:ga.male,female:ga.female,total:0},va={male:ga.male-(S.New_Signups.male-S.Deleted.male),female:ga.female-(S.New_Signups.female-S.Deleted.female),total:0},wa={male:va.male-(T.New_Signups.male-T.Deleted.male),female:va.female-(T.New_Signups.female-T.Deleted.female),total:0},xa={male:wa.male-(U.New_Signups.male-U.Deleted.male),female:wa.female-(U.New_Signups.female-U.Deleted.female),total:0},ya={male:xa.male-(V.New_Signups.male-V.Deleted.male),female:xa.female-(V.New_Signups.female-V.Deleted.female),total:0},za={male:ya.male-(W.New_Signups.male-W.Deleted.male),female:ya.female-(W.New_Signups.female-W.Deleted.female),total:0},Aa={male:za.male-(X.New_Signups.male-X.Deleted.male),female:za.female-(X.New_Signups.female-X.Deleted.female),total:0},Ba={male:Aa.male-(Y.New_Signups.male-Y.Deleted.male),female:Aa.female-(Y.New_Signups.female-Y.Deleted.female),total:0},Ca={male:Ba.male-(Z.New_Signups.male-Z.Deleted.male),female:Ba.female-(Z.New_Signups.female-Z.Deleted.female),total:0},Da={male:Ca.male-(_.New_Signups.male-_.Deleted.male),female:Ca.female-(_.New_Signups.female-_.Deleted.female),total:0},Ea={male:Da.male-(aa.New_Signups.male-aa.Deleted.male),female:Da.female-(aa.New_Signups.female-aa.Deleted.female),total:0},Fa={male:Ea.male-(ba.New_Signups.male-ba.Deleted.male),female:Ea.female-(ba.New_Signups.female-ba.Deleted.female),total:0};ua.total=ua.male+ua.female,va.total=va.male+va.female,wa.total=wa.male+wa.female,xa.total=xa.male+xa.female,ya.total=ya.male+ya.female,za.total=za.male+za.female,Aa.total=Aa.male+Aa.female,Ba.total=Ba.male+Ba.female,Ca.total=Ca.male+Ca.female,Da.total=Da.male+Da.female,Ea.total=Ea.male+Ea.female,Fa.total=Fa.male+Fa.female;var Ga={male:ha.male,female:ha.female,total:0},Ha={male:ha.male-S.Visits.male,female:ha.female-S.Visits.female,total:0},Ia={male:Ha.male-T.Visits.male,female:Ha.female-T.Visits.female,total:0},Ja={male:Ia.male-U.Visits.male,female:Ia.female-U.Visits.female,total:0},Ka={male:Ja.male-V.Visits.male,female:Ja.female-V.Visits.female,total:0},La={male:Ka.male-W.Visits.male,female:Ka.female-W.Visits.female,total:0},Ma={male:La.male-X.Visits.male,female:La.female-X.Visits.female,total:0},Na={male:Ma.male-Y.Visits.male,female:Ma.female-Y.Visits.female,total:0},Oa={male:Na.male-Z.Visits.male,female:Na.female-Z.Visits.female,total:0},Pa={male:Oa.male-_.Visits.male,female:Oa.female-_.Visits.female,total:0},Qa={male:Pa.male-aa.Visits.male,female:Pa.female-aa.Visits.female,total:0},Ra={male:Qa.male-ba.Visits.male,female:Qa.female-ba.Visits.female,total:0};Ga.total=Ga.male+Ga.female,Ha.total=Ha.male+Ha.female,Ia.total=Ia.male+Ia.female,Ja.total=Ja.male+Ja.female,Ka.total=Ka.male+Ka.female,La.total=La.male+La.female,Ma.total=Ma.male+Ma.female,Na.total=Na.male+Na.female,Oa.total=Oa.male+Oa.female,Pa.total=Pa.male+Pa.female,Qa.total=Qa.male+Qa.female,Ra.total=Ra.male+Ra.female;var Sa=new App.Views.TrendActivityReport;Sa.data=da,Sa.startDate=C.startkey,Sa.endDate=C.endkey,Sa.render(),App.$el.children(".body").html(Sa.el),$("#trend-report-div-total-members").highcharts({chart:{type:"column",borderColor:"#999999",borderWidth:2,borderRadius:10},title:{text:"Total Registered Members Past 12 Months"},xAxis:{categories:[ea[z.getMonth()]+" "+z.getFullYear(),ea[x.getMonth()]+" "+x.getFullYear(),ea[v.getMonth()]+" "+v.getFullYear(),ea[t.getMonth()]+" "+t.getFullYear(),ea[r.getMonth()]+" "+r.getFullYear(),ea[p.getMonth()]+" "+p.getFullYear(),ea[n.getMonth()]+" "+n.getFullYear(),ea[l.getMonth()]+" "+l.getFullYear(),ea[j.getMonth()]+" "+j.getFullYear(),ea[h.getMonth()]+" "+h.getFullYear(),ea[f.getMonth()]+" "+f.getFullYear(),ea[d.getMonth()]+" "+d.getFullYear()]},yAxis:{min:0,title:{text:"Members Count"}},tooltip:{headerFormat:'<span style="font-size:10px">{point.key}</span><table>',pointFormat:'<tr><td style="color:{series.color};padding:0">{series.name}: </td><td style="padding:0"><b>{point.y}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0}},series:[{name:"Males",data:[Fa.male,Ea.male,Da.male,Ca.male,Ba.male,Aa.male,za.male,ya.male,xa.male,wa.male,va.male,ua.male],color:"#33ccff"},{name:"Females",data:[Fa.female,Ea.female,Da.female,Ca.female,Ba.female,Aa.female,za.female,ya.female,xa.female,wa.female,va.female,ua.female],color:"#66ff66"},{name:"Total",data:[Fa.total,Ea.total,Da.total,Ca.total,Ba.total,Aa.total,za.total,ya.total,xa.total,wa.total,va.total,ua.total],color:"#ff9900"}]}),$("#trend-report-div-total-member-visits").highcharts({chart:{type:"column",borderColor:"#999999",borderWidth:2,borderRadius:10},title:{text:"Total Visits Past 12 Months"},xAxis:{categories:[ea[z.getMonth()]+" "+z.getFullYear(),ea[x.getMonth()]+" "+x.getFullYear(),ea[v.getMonth()]+" "+v.getFullYear(),ea[t.getMonth()]+" "+t.getFullYear(),ea[r.getMonth()]+" "+r.getFullYear(),ea[p.getMonth()]+" "+p.getFullYear(),ea[n.getMonth()]+" "+n.getFullYear(),ea[l.getMonth()]+" "+l.getFullYear(),ea[j.getMonth()]+" "+j.getFullYear(),ea[h.getMonth()]+" "+h.getFullYear(),ea[f.getMonth()]+" "+f.getFullYear(),ea[d.getMonth()]+" "+d.getFullYear()]},yAxis:{min:0,title:{text:"Visits Count"}},tooltip:{headerFormat:'<span style="font-size:10px">{point.key}</span><table>',pointFormat:'<tr><td style="color:{series.color};padding:0">{series.name}: </td><td style="padding:0"><b>{point.y}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0}},series:[{name:"Males",data:[Ra.male,Qa.male,Pa.male,Oa.male,Na.male,Ma.male,La.male,Ka.male,Ja.male,Ia.male,Ha.male,Ga.male],color:"#33ccff"},{name:"Females",data:[Ra.female,Qa.female,Pa.female,Oa.female,Na.female,Ma.female,La.female,Ka.female,Ja.female,Ia.female,Ha.female,Ga.female],color:"#66ff66"},{name:"Total",data:[Ra.total,Qa.total,Pa.total,Oa.total,Na.total,Ma.total,La.total,Ka.total,Ja.total,Ia.total,Ha.total,Ga.total],color:"#ff9900"}]}),$("#trend-report-div-new-memberships").highcharts({chart:{type:"column",borderColor:"#999999",borderWidth:2,borderRadius:10},title:{text:"Active Members This Month"},xAxis:{categories:[ea[z.getMonth()]+" "+z.getFullYear(),ea[x.getMonth()]+" "+x.getFullYear(),ea[v.getMonth()]+" "+v.getFullYear(),ea[t.getMonth()]+" "+t.getFullYear(),ea[r.getMonth()]+" "+r.getFullYear(),ea[p.getMonth()]+" "+p.getFullYear(),ea[n.getMonth()]+" "+n.getFullYear(),ea[l.getMonth()]+" "+l.getFullYear(),ea[j.getMonth()]+" "+j.getFullYear(),ea[h.getMonth()]+" "+h.getFullYear(),ea[f.getMonth()]+" "+f.getFullYear(),ea[d.getMonth()]+" "+d.getFullYear()]},yAxis:{min:0,title:{text:"Members Count"}},tooltip:{headerFormat:'<span style="font-size:10px">{point.key}</span><table>',pointFormat:'<tr><td style="color:{series.color};padding:0">{series.name}: </td><td style="padding:0"><b>{point.y}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0}},series:[{name:"Males",data:[ta.male,sa.male-ta.male,ra.male-sa.male,qa.male-ra.male,pa.male-qa.male,oa.male-pa.male,na.male-oa.male,ma.male-na.male,la.male-ma.male,ka.male-la.male,ja.male-ka.male,fa.male-ja.male],color:"#33ccff"},{name:"Females",data:[ta.female,sa.female-ta.female,ra.female-sa.female,qa.female-ra.female,pa.female-qa.female,oa.female-pa.female,na.female-oa.female,ma.female-na.female,la.female-ma.female,ka.female-la.female,ja.female-ka.female,fa.female-ja.female],color:"#66ff66"},{name:"Total",data:[ta.total,sa.total-ta.total,ra.total-sa.total,qa.total-ra.total,pa.total-qa.total,oa.total-pa.total,na.total-oa.total,ma.total-na.total,la.total-ma.total,ka.total-la.total,ja.total-ka.total,ia.total-ja.total],color:"#ff9900"}]}),$("#trend-report-div-visits").highcharts({chart:{type:"column",borderColor:"#999999",borderWidth:2,borderRadius:10},title:{text:"Total Member Visits This Month"},xAxis:{categories:[ea[z.getMonth()]+" "+z.getFullYear(),ea[x.getMonth()]+" "+x.getFullYear(),ea[v.getMonth()]+" "+v.getFullYear(),ea[t.getMonth()]+" "+t.getFullYear(),ea[r.getMonth()]+" "+r.getFullYear(),ea[p.getMonth()]+" "+p.getFullYear(),ea[n.getMonth()]+" "+n.getFullYear(),ea[l.getMonth()]+" "+l.getFullYear(),ea[j.getMonth()]+" "+j.getFullYear(),ea[h.getMonth()]+" "+h.getFullYear(),ea[f.getMonth()]+" "+f.getFullYear(),ea[d.getMonth()]+" "+d.getFullYear()]},yAxis:{min:0,title:{text:"Visits Count"}},tooltip:{headerFormat:'<span style="font-size:10px">{point.key}</span><table>',pointFormat:'<tr><td style="color:{series.color};padding:0">{series.name}: </td><td style="padding:0"><b>{point.y}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0}},series:[{name:"Males",data:[ca.Visits.male,ba.Visits.male,aa.Visits.male,_.Visits.male,Z.Visits.male,Y.Visits.male,X.Visits.male,W.Visits.male,V.Visits.male,U.Visits.male,T.Visits.male,S.Visits.male],color:"#33ccff"},{name:"Females",data:[ca.Visits.female,ba.Visits.female,aa.Visits.female,_.Visits.female,Z.Visits.female,Y.Visits.female,X.Visits.female,W.Visits.female,V.Visits.female,U.Visits.female,T.Visits.female,S.Visits.female],color:"#66ff66"},{name:"Total",data:[ca.Visits.male+ca.Visits.female,ba.Visits.male+ba.Visits.female,aa.Visits.male+aa.Visits.female,_.Visits.male+_.Visits.female,Z.Visits.male+Z.Visits.female,Y.Visits.male+Y.Visits.female,X.Visits.male+X.Visits.female,W.Visits.male+W.Visits.female,V.Visits.male+V.Visits.female,U.Visits.male+U.Visits.female,T.Visits.male+T.Visits.female,S.Visits.male+S.Visits.female],color:"#ff9900"}]}),$("#trend-report-div-total-resource-views-this-month").highcharts({chart:{type:"column",borderColor:"#999999",borderWidth:2,borderRadius:10},title:{text:"Total Resource Views This Month"},xAxis:{categories:[ea[z.getMonth()]+" "+z.getFullYear(),ea[x.getMonth()]+" "+x.getFullYear(),ea[v.getMonth()]+" "+v.getFullYear(),ea[t.getMonth()]+" "+t.getFullYear(),ea[r.getMonth()]+" "+r.getFullYear(),ea[p.getMonth()]+" "+p.getFullYear(),ea[n.getMonth()]+" "+n.getFullYear(),ea[l.getMonth()]+" "+l.getFullYear(),ea[j.getMonth()]+" "+j.getFullYear(),ea[h.getMonth()]+" "+h.getFullYear(),ea[f.getMonth()]+" "+f.getFullYear(),ea[d.getMonth()]+" "+d.getFullYear()]},yAxis:{min:0,title:{text:"Resource count"}},tooltip:{headerFormat:'<span style="font-size:10px">{point.key}</span><table>',pointFormat:'<tr><td style="color:{series.color};padding:0">{series.name}: </td><td style="padding:0"><b>{point.y}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0}},series:[{name:"Males",data:[ca.ResourceViews.male,ba.ResourceViews.male,aa.ResourceViews.male,_.ResourceViews.male,Z.ResourceViews.male,Y.ResourceViews.male,X.ResourceViews.male,W.ResourceViews.male,V.ResourceViews.male,U.ResourceViews.male,T.ResourceViews.male,S.ResourceViews.male],color:"#33ccff"},{name:"Females",data:[ca.ResourceViews.female,ba.ResourceViews.female,aa.ResourceViews.female,_.ResourceViews.female,Z.ResourceViews.female,Y.ResourceViews.female,X.ResourceViews.female,W.ResourceViews.female,V.ResourceViews.female,U.ResourceViews.female,T.ResourceViews.female,S.ResourceViews.female],color:"#66ff66"},{name:"Total",data:[ca.ResourceViews.male+ca.ResourceViews.female,ba.ResourceViews.male+ba.ResourceViews.female,aa.ResourceViews.male+aa.ResourceViews.female,_.ResourceViews.male+_.ResourceViews.female,Z.ResourceViews.male+Z.ResourceViews.female,Y.ResourceViews.male+Y.ResourceViews.female,X.ResourceViews.male+X.ResourceViews.female,W.ResourceViews.male+W.ResourceViews.female,V.ResourceViews.male+V.ResourceViews.female,U.ResourceViews.male+U.ResourceViews.female,T.ResourceViews.male+T.ResourceViews.female,S.ResourceViews.male+S.ResourceViews.female],color:"#ff9900"}]})}else alert("You must choose a date to proceed")})},isWithinRange:function(a,b,c){},ReportForm:function(a){var b=a?new App.Models.CommunityReport({_id:a}):new App.Models.CommunityReport;b.on("processed",function(){Backbone.history.navigate("report",{trigger:!0})});var c=new App.Views.ReportForm({model:b});App.$el.children(".body").html(c.el),b.id?(App.listenToOnce(b,"sync",function(){c.render()}),b.fetch()):c.render()},routeStartupTasks:function(){$("#invitationdiv").hide(),$("#debug").hide()},Resource_Detail:function(a,b,c){var d=new App.Models.Resource({_id:a});d.fetch({success:function(){var a=d.toJSON().Tag,e=JSON.stringify(a),f=Array(),g=Backbone.Collection.extend({url:App.Server+"/collectionlist/_design/bell/_view/DocById?keys="+e+"&include_docs=true"}),h=new g;h.fetch({async:!1}),h=h.first(),void 0!=h&&(accessedTags=h.toJSON().rows,_.each(accessedTags,function(a){f.push(a.value)})),d.set({Tag:f});var i=new App.Views.ResourcesDetail({model:d});i.SetShelfId(b,c),i.render(),App.$el.children(".body").html(i.el)}})},RenderTagSelect:function(a){var b=new App.Collections.listRCollection;b.major=!0,b.fetch({async:!1}),b.each(function(b){$(a).append('<option value="'+b.get("_id")+'" class="MajorCategory">'+b.get("CollectionName")+"</option>")});var c=new App.Collections.listRCollection;c.major=!1,c.fetch({async:!1}),_.each(c.last(c.length).reverse(),function(b){"--Select--"==b.get("NesttedUnder")?$(a).append('<option value="'+b.get("_id")+'">'+b.get("CollectionName")+"</option>"):null!=$(a+' option[value="'+b.get("NesttedUnder")+'"]')&&$(a).find('option[value="'+b.get("NesttedUnder")+'"]').after('<option value="'+b.get("_id")+'">'+b.get("CollectionName")+"</option>")})},ResourceFeedback:function(a){var b=new App.Models.Resource;b.id=a,b.on("sync",function(){var c=new App.Collections.ResourceFeedback;c.resourceId=a;var d=new App.Views.FeedbackTable({collection:c});c.on("sync",function(){d.render(),App.$el.children(".body").html('<h3>Feedback for "'+b.get("title")+'"</h3>');var c="#resource/feedback/add/"+a+"/"+b.get("title");App.$el.children(".body").append('<a class="btn btn-primary"" href="'+c+'"><i class="icon-plus"></i> Add your feedback</a>'),App.$el.children(".body").append('<a class="btn btn-primary" style="margin:20px" href="#resources"><< Back to Resources</a>'),App.$el.children(".body").append(d.el)}),c.fetch()}),b.fetch()},FeedbackForm:function(a,b){var c=new App.Models.Feedback({resourceId:a,memberId:$.cookie("Member._id")});c.on("sync",function(){Backbone.history.navigate("resource/feedback/"+a,{trigger:!0})});var d=new App.Models.Resource({_id:a});d.fetch({async:!1});var e=new App.Views.FeedbackForm({model:c});e.rtitle=d.get("title");e.render(),App.$el.children(".body").html('<h4 style="color:gray">Add Feedback For<span style="color:black;"> '+d.get("title")+"</span></h4>"),App.$el.children(".body").append('<p style="font-size:15px;">&nbsp;&nbsp;<span style="font-size:50px;">.</span>Rating </p>'),App.$el.children(".body").append('<div id="star" data-score="0"></div>'),$("#star").raty(),$("#star > img").click(function(){e.setUserRating($(this).attr("alt"))}),App.$el.children(".body").append(e.el)},email:function(){App.$el.children(".body").html("&nbsp");var a=new App.Collections.Configurations;a.fetch({async:!1});var b=a.first(),c=b.toJSON();code=c.code,Bellname=c.nationName;var d=new App.Collections.Mails({skip:0});d.fetch({async:!1});var e=new App.Views.MailView({collection:d,community_code:code,nationName:Bellname});e.render(),App.$el.children(".body").append(e.el),skipStack.push(skip),e.fetchRecords()},CoursesBarChart:function(){App.$el.children(".body").html("&nbsp"),App.$el.children(".body").append('<div id="veticallable"><b>S<br/>T<br/>E<br/>P<br/>S<br/></b></div>'),App.$el.children(".body").append('<div id="graph"></div>'),App.$el.children(".body").append('<div id="horizontallabel"><b>COURSES</b></div>');var a=new App.Collections.memberprogressallcourses;a.memberId=$.cookie("Member._id"),a.fetch({async:!1});var b=new App.Views.CoursesChartProgress({collection:a});b.render(),App.$el.children(".body").append(b.el)},AddToShelf:function(a,b){var c=new App.Collections.shelfResource;if(c.resourceId=a,c.memberId=$.cookie("Member._id"),c.fetch({async:!1}),0==c.length){var d=new App.Models.Shelf;d.set("memberId",$.cookie("Member._id")),d.set("resourceId",a),d.set("resourceTitle",unescape(b)),d.save(null,{success:function(a,b,c){}}),alert("Successfully Add To Shelf")}else alert("Already in Shelf")},AddToShelfAndSaveFeedback:function(a,b){var c=new App.Collections.shelfResource;if(c.resourceId=a,c.memberId=$.cookie("Member._id"),c.fetch({async:!1}),0==c.length){var d=new App.Models.Shelf;d.set("memberId",$.cookie("Member._id")),d.set("resourceId",a),d.set("resourceTitle",unescape(b)),d.save(null,{success:function(a,b,c){}}),alert("Successfully Saved Feedback and Add To Shelf")}else alert("Successfully Saved Feedback,Resource Already in Shelf");Backbone.history.navigate("resources",{trigger:!0})},CalendarFunction:function(){App.$el.children(".body").html("<div id='addEvent' style='position:fixed;z-index:5;' class='btn btn-primary' onclick =\"document.location.href='#addEvent'\">Add Event</div><br/><br/>"),App.$el.children(".body").append("<br/><br/><div id='calendar'></div>"),$(document).ready(function(){var a=[],b=new App.Collections.Calendars;b.fetch({async:!1}),b.each(function(b){if(b.get("startDate")&&b.get("endDate")){var c=b.get("startDate").split("/"),d=b.get("endDate").split("/");daysindex=new Array(0,1,2,3,4,5,6);for(var e=getScheduleDatesForCourse(new Date(c[2],--c[0],c[1]),new Date(d[2],--d[0],d[1]),daysindex),f=convertTo24Hour(b.get("startTime")),g=convertTo24Hour(b.get("endTime")),h=0;h<e.length;h++){var i=new Object;i.title=b.get("title"),i.start=new Date(e[h].setHours(f)),i.end=new Date(e[h].setHours(g)),i.url="calendar/event/"+b.id,i.allDay=!1,a.push(i)}}});var c=new App.Collections.MemberGroups;c.fetch({async:!1}),c.each(function(b){var c;if("Daily"==b.get("frequency"))c=new Array(0,1,2,3,4,5,6);else{c=new Array;var d=new Array("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"),e=b.get("Day");if(e instanceof Array);else{var f=e;e=new Array,e[0]=f}for(var g=0;g<e.length;)c.push(d.indexOf(e[g])),g++}if(b.get("startDate")&&b.get("startDate"))for(var h=b.get("startDate").split("/"),i=b.get("endDate").split("/"),j=getScheduleDatesForCourse(new Date(h[2],--h[0],h[1]),new Date(i[2],--i[0],i[1]),c),k=convertTo24Hour(b.get("startTime")),l=convertTo24Hour(b.get("endTime")),g=0;g<j.length;g++){var f=new Object;f.title="\nCourse: \n"+b.get("name"),f.start=new Date(j[g].setHours(k)),f.end=new Date(j[g].setHours(l)),f.allDay=!1,a.push(f)}});var d=new App.Collections.UserMeetups;d.memberId=$.cookie("Member._id"),d.fetch({async:!1}),d.each(function(b){model=new App.Models.MeetUp({_id:b.get("meetupId")}),model.fetch({async:!1});var c;if("Daily"==model.get("reoccuring"))c=new Array(0,1,2,3,4,5,6);else{c=new Array;var d=new Array("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"),e=model.get("Day");if(e instanceof Array);else{var f=e;e=new Array,e[0]=f}for(var g=0;g<e.length;)c.push(d.indexOf(e[g])),g++}if(model.get("startDate")&&model.get("startDate"))for(var h=model.get("startDate").split("/"),i=model.get("endDate").split("/"),j=getScheduleDatesForCourse(new Date(h[2],--h[0],h[1]),new Date(i[2],--i[0],i[1]),c),k=convertTo24Hour(model.get("startTime")),l=convertTo24Hour(model.get("endTime")),g=0;g<j.length;g++){var f=new Object;f.title="\nMeetup: \n"+model.get("title"),f.start=new Date(j[g].setHours(k)),f.end=new Date(j[g].setHours(l)),f.allDay=!1,a.push(f)}});$("#calendar").fullCalendar({header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},selectable:!0,eventClick:function(a){return Backbone.history.navigate(a.url,{trigger:!0}),!1},events:a})})},addEvent:function(){var a=new App.Models.Calendar,b=new App.Views.CalendarForm({model:a});App.$el.children(".body").html('<h3 class="signup-heading">Add Event</h3>'),App.$el.children(".body").append(b.el),b.render(),$(".bbf-form .field-startTime input").timepicker({minTime:"8:00am",maxTime:"12:30am"}),$(".bbf-form .field-endTime input").timepicker({minTime:"8:00am",maxTime:"12:30am"}),$(".bbf-form .field-startDate input").datepicker({todayHighlight:!0}),$(".bbf-form .field-endDate input").datepicker({todayHighlight:!0})},calendaar:function(a){App.$el.children(".body").html("&nbsp");var b=new App.Models.Calendar({_id:a});b.fetch({async:!1});var c=new App.Views.EventInfo({model:b});c.render(),App.$el.children(".body").append(c.el)},EditEvent:function(a){var b=new App.Models.Calendar({_id:a});b.fetch({async:!1});var c=new App.Views.CalendarForm({model:b});c.update=!0,App.$el.children(".body").html('<h3 class="signup-heading">Update Event</h3>'),App.$el.children(".body").append(c.el),c.render()},EditTag:function(a){var b=this.getRoles();if(b.indexOf("Manager")>-1&&"Add New"!=a){var c=new App.Collections.listRCollection;c.major=!0,c.fetch({async:!1}),$("#invitationdiv").fadeIn(1e3),document.getElementById("cont").style.opacity=.2,document.getElementById("nav").style.opacity=.2;var d=new App.Models.CollectionList({_id:a});d.fetch({async:!1}),c.remove(d);var e=new App.Views.ListCollectionView({model:d});e.render(),$("#invitationdiv").html("&nbsp"),$("#invitationdiv").append(e.el),c.each(function(a){$("#invitationForm .bbf-form .field-NesttedUnder select").append('<option value="'+a.get("_id")+'" class="MajorCategory">'+a.get("CollectionName")+"</option>")}),$('#invitationForm .bbf-form .field-NesttedUnder select option[value="'+d.get("NesttedUnder")+'"]').attr("selected","selected"),$("#invitationForm .bbf-form .field-IsMajor input").is(":checked")?$("#invitationForm .bbf-form .field-NesttedUnder").css("visibility","hidden"):$("#invitationForm .bbf-form .field-NesttedUnder").css("visibility","visible"),$("#invitationForm .bbf-form .field-AddedDate input",this.el).datepicker({todayHighlight:!0}),$("input[name='AddedBy']").attr("disabled",!0)}},AddNewSelect:function(a){if("Add New"==a){var b=new App.Collections.listRCollection;b.major=!0,b.fetch({async:!1}),$("#invitationdiv").fadeIn(1e3),document.getElementById("cont").style.opacity=.2,document.getElementById("nav").style.opacity=.2;var c=new App.Models.CollectionList,d=new App.Views.ListCollectionView({model:c});d.render(),$("#invitationdiv").html("&nbsp"),$("#invitationdiv").append(d.el),$("input[name='AddedBy']").val($.cookie("Member.login"));var e=new Date;$("#invitationForm .bbf-form .field-AddedDate input",this.el).datepicker({todayHighlight:!0}),$("#invitationForm .bbf-form .field-AddedDate input",this.el).datepicker("setDate",e),$("input[name='AddedBy']").attr("disabled",!0),$("input[name='AddedDate']").attr("disabled",!0),b.each(function(a){$("#invitationForm .bbf-form .field-NesttedUnder select").append('<option value="'+a.get("_id")+'" class="MajorCategory">'+a.get("CollectionName")+"</option>")})}else document.getElementById("cont").style.opacity=1,document.getElementById("nav").style.opacity=1,$("#invitationdiv").hide()},Collection:function(){App.startActivityIndicator();var a=$.url().data.attr.host.split(".");a=a[0].substring(3),""==a&&(a="local");var b=this.getRoles(),c=new App.Collections.listRCollection;c.major=!0,c.fetch({success:function(){var a=new App.Views.CollectionTable({collection:c});a.render(),App.$el.children(".body").html('<p style="margin-top:20px"><a class="btn btn-success" href="#resource/add">Add New Resource</a><a style="margin-left:10px" class="btn btn-success" onclick=showRequestForm("Resource")>Request Resource</a></p></span>'),App.$el.children(".body").append('<p style="font-size:30px;color:#808080"><a href="#resources"style="font-size:30px;">Resources</a>&nbsp&nbsp|&nbsp&nbsp<a href="#collection" style="font-size:30px;color:#0088CC;text-decoration: underline;">Collections</a></p>'),-1!=b.indexOf("Manager")&&App.$el.children(".body").append('<button style="margin:-90px 0px 0px 500px;" class="btn btn-success"  onclick="AddColletcion()">Add Collection</button>'),App.$el.children(".body").append(a.el)},async:!1});var d=new App.Collections.listRCollection;d.major=!1,d.fetch({async:!1}),-1!=b.indexOf("Manager")?_.each(d.last(d.length).reverse(),function(a){"--Select--"==a.get("NesttedUnder")?$("#collectionTable").append('<tr><td><a href="#listCollection/'+a.get("_id")+"/"+a.get("CollectionName")+'">'+a.get("CollectionName")+"</a></td><td><button onclick=EditColletcion("+a.get("_id")+')><i class="icon-edit pull-right"></i></button></td></tr>'):$("#"+a.get("NesttedUnder")).parent().after('<tr><td>&nbsp&nbsp&nbsp&nbsp<a href="#listCollection/'+a.get("_id")+"/"+a.get("CollectionName")+'">'+a.get("CollectionName")+'</a></td><td><button onclick=EditColletcion("'+a.get("_id")+'")><i class="icon-edit pull-right"></i></button></td></tr>');
}):_.each(d.last(d.length).reverse(),function(a){"--Select--"==a.get("NesttedUnder")?$("#collectionTable").append('<tr><td><a href="#listCollection/'+a.get("_id")+"/"+a.get("CollectionName")+'">'+a.get("CollectionName")+"</a></td><td></td></tr>"):$("#"+a.get("NesttedUnder")).parent().after('<tr><td>&nbsp&nbsp&nbsp&nbsp<a href="#listCollection/'+a.get("_id")+"/"+a.get("CollectionName")+'">'+a.get("CollectionName")+"</a></td><td></td></tr>")}),App.stopActivityIndicator()},mergecollection:function(a,b){for(var c=0;c<a.length;c++){var d=new App.Models.CollectionList({_id:a[c]});d.fetch({success:function(a){a.destroy()}})}var e=new App.Collections.Resources;e.collectionName=JSON.stringify(a),e.fetch({success:function(c){var d=new App.Models.CollectionList;d.set("CollectionName",b),d.set("Description",""),d.set("IsMajor",!0),d.set("NesttedUnder","--Select--"),d.set("AddedBy",$.cookie("Member.login")),d.set("AddedDate",new Date),d.set("show",!0),d.save(null,{success:function(b,d){var e=d.id;c.each(function(b){if(resourceTags=b.get("Tag"),Array.isArray(resourceTags)){for(var c=0;c<a.length;c++)if(-1!=resourceTags.indexOf(a[c])){var d=resourceTags.indexOf(a[c]);resourceTags.splice(d,1)}resourceTags.push(e),b.set("Tag",resourceTags),b.save()}}),alert("Collections Merge Successfully"),document.getElementById("cont").style.opacity=1,document.getElementById("nav").style.opacity=1,$("#invitationdiv").hide(),location.reload()}})}})},viewAllFeedback:function(){feed=new App.Collections.siteFeedbacks,feed.fetch({success:function(){feedul=new App.Views.siteFeedbackPage({collection:feed}),feedul.render(),App.$el.children(".body").html("&nbsp"),App.$el.children(".body").append(feedul.el)}})},ListCollection:function(a,b){App.startActivityIndicator();var c=$.url().data.attr.host.split(".");c=c[0].substring(3),""==c&&(c="local");var d=this.getRoles(),e=new App.Models.CollectionList({_id:a});e.fetch({async:!1});var f=Array();f.push(a),f=JSON.stringify(f);var g=new App.Collections.Resources({collectionName:f});g.fetch({success:function(){var a=new App.Views.ResourcesTable({collection:g});a.displayCollec_Resources=!0,a.collections=App.collectionslist,a.isManager=d.indexOf("Manager"),a.render(),App.$el.children(".body").html('<p style="margin-top:20px"><a class="btn btn-success" href="#resource/add">Add New Resource</a><a style="margin-left:10px" class="btn btn-success" onclick=showRequestForm("Resource")>Request Resource</a><span style="float:right"></span></p>'),App.$el.children(".body").append('<p style="font-size:30px;color:#808080;"><a href="#resources"style="font-size:30px;color:#0088CC;text-decoration: underline;">Resources</a>&nbsp&nbsp|&nbsp&nbsp<a href="#collection" style="font-size:30px;">Collections</a> </p>'),App.$el.children(".body").append('<p style="font-size: 30px;font-weight: bolder;color: #808080;width: 450px;word-wrap: break-word;">'+e.get("CollectionName")+"</p>"),App.$el.children(".body").append(a.el),$("#backButton").click(function(){Backbone.history.navigate("#resources",{trigger:!1})})}}),App.stopActivityIndicator()},NewsFeed:function(){this.underConstruction()},AllRequests:function(){App.$el.children(".body").html("&nbsp");var a=new App.Collections.Requests;a.fetch({async:!1});var b=new App.Views.RequestTable({collection:a});b.render(),App.$el.children(".body").append(b.el)},myRequests:function(){App.$el.children(".body").html("&nbsp");var a=new App.Collections.Requests({memberId:$.cookie("Member._id")});a.fetch({async:!1});var b=new App.Views.RequestTable({collection:a});b.render(),App.$el.children(".body").append(b.el)},synchCommunityWithURL:function(a,b){console.log("http://"+b+":"+App.password+"@"+a+":5984/resources"),$.ajax({headers:{Accept:"application/json","Content-Type":"application/json; charset=utf-8"},type:"POST",url:"/_replicate",dataType:"json",data:JSON.stringify({source:"resources",target:"http://"+b+":"+App.password+"@"+a+":5984/resources"}),success:function(a){},async:!1})},PochDB:function(){var a=$.cookie("Member._id"),b=($.cookie("Member.login"),new App.Collections.Members,new App.Models.Member({_id:a}));b.fetch({async:!1});var c=null,d=(b.get("login"),Backbone.history.location.href);d=d.split("/");var e=d[2].split("."),f=new PouchDB("feedback");c=-1!=e[0].indexOf("cloudant")?"http://"+e[0]+":"+App.password+"@"+d[2]:e[0].match(/^\d*[0-9](\.\d*[0-9])?$/)?"http://"+d[2]:"http://"+d[2],f.replicate.to(c+"/feedback",function(a,b){a?console.log("FeedBackDb replication error :"+a):console.log("Successfully replicated FeedBackDb :"+b)}),this.syncResourceFeedback(),this.WeeklyReports()},syncResourceFeedback:function(){var a=new PouchDB("resources");a.allDocs({include_docs:!0},function(b,c){console.log(c),_.each(c.rows,function(b){var c=b.doc._id,d=new App.Models.Resource({_id:c});d.fetch({success:function(){void 0==d.get("sum")||void 0==d.get("timesRated")?(d.set("sum",0),d.set("timesRated",0)):(d.set("sum",parseInt(d.get("sum"))+parseInt(b.doc.sum)),d.set("timesRated",parseInt(d.get("timesRated"))+parseInt(b.doc.timesRated))),d.save(null,{success:function(c,d){a.put({sum:0,timesRated:0},b.doc._id,b.doc._rev,function(a,b){a?console.log(a):console.log(b)}),a.remove(b.doc._id,b.doc._rev,function(a,b){a?console.log(a):console.log(b)})}})}})})})},saveResources:function(a){var b=new PouchDB("resources"),c=new App.Collections.MemberGroups;c.memberId=$.cookie("Member._id"),c.once("sync",function(){_.each(c.models,function(a){levels=new App.Collections.CourseLevels,levels.groupId=a.id,levels.fetch({async:!1}),levels.each(function(a){var c=a.get("resourceId");_.each(c,function(a){var c=new App.Models.Resource({_id:a});c.fetch({success:function(a){var d=a.toJSON();console.log(d),b.get(d._id,function(a,e){a?b.post({_id:d._id,sum:0,timesRated:0}):(console.log("Sum   "+d.sum+"    "+e.sum),console.log("timesRated   "+d.timesRated+"    "+e.timesRated),d.sum&&d.timesRated?(c.set("sum",parseInt(d.sum)+parseInt(e.sum)),c.set("timesRated",parseInt(d.timesRated)+parseInt(e.timesRated))):(c.set("sum",0),c.set("timesRated",0)),c.save(null,{success:function(a,c){b.put({sum:0,timesRated:0},e._id,e._rev,function(a,b){})}}))})}})})})})}),c.fetch()},saveFrequency:function(a){if($.cookie("Member._id")){var b=new PouchDB("resourcefrequency"),c=new App.Collections.ResourcesFrequency;c.memberID=$.cookie("Member._id"),c.fetch(null,{success:function(a,d){console.log(c.toJSON());var e=c.first().toJSON();b.put(e,e._id,e._rev,function(a,b){a?console.log("ResourceFrequencyDB replication error :"+a):console.log("Successfully replicated ResourceFrequencyDB :"+b)})}}),b.replicate.to(a+"/resourcefrequency",function(a,b){a?console.log("ResourceFrequencyDB replication error :"+a):console.log("Successfully replicated ResourceFrequencyDB :"+b)})}},LogQuery:function(){var a="community",b=Backbone.Collection.extend({url:App.Server+"/configurations/_all_docs?include_docs=true"}),c=new b;c.fetch({async:!1});var d=c.first(),e=d.toJSON();e.rows[0].doc.type&&(a=e.rows[0].doc.type);var f=new App.Views.LogQuery;f.type=a,f.render(),App.$el.children(".body").html(f.el),$("#community-select").hide(),$("#start-date").datepicker({dateFormat:"yy-mm-dd",todayHighlight:!0}),$("#end-date").datepicker({dateFormat:"yy-mm-dd",todayHighlight:!0})},changeDateFormat:function(a){var b=a.match(/\d+/g),c=b[0],d=b[1],e=b[2];return c+"/"+d+"/"+e},deletePouchDB:function(){var a=new PouchDB("resources");a.destroy(function(a,b){a?console.log(a):console.log("deleted successfully "+b)});var b=new PouchDB("feedback");b.destroy(function(a,b){a?console.log(a):console.log("Successfully Deleted feedback"+b)});var c=new PouchDB("members");c.destroy(function(a,b){a?console.log(a):console.log("Successfully Deleted members"+b)});var d=new PouchDB("resourcefrequency");d.destroy(function(a,b){a?console.log(a):console.log("Successfully Destroy ResourceFrequency"+b)});var e=new PouchDB("membercourseprogress");e.destroy(function(a,b){a?console.log(a):console.log("Successfully Destroy membercourseprogress"+b)});var f=new PouchDB("coursestep");f.destroy(function(a,b){a?console.log(a):console.log("Successfully Destroy coursestep"+b)});var g=new PouchDB("activitylogs");return g.destroy(function(a,b){a?console.log(a):console.log("Successfully Destroy activitylogs"+b)}),!0},dbinfo:function(){var a=new PouchDB("resources");a.info(function(a,b){console.log(b)});var b=new PouchDB("feedback");b.info(function(a,b){console.log(b)});var c=new PouchDB("members");c.info(function(a,b){console.log(b)});var d=new PouchDB("resourcefrequency");d.info(function(a,b){console.log(b)});var e=new PouchDB("coursestep");e.info(function(a,b){console.log(b)});var f=new PouchDB("membercourseprogress");f.info(function(a,b){console.log(b),console.log(a)});var g=new PouchDB("activitylogs");g.info(function(a,b){console.log(b)})},CompileAppManifest:function(){var a=new App.Collections.Apps,b="{replace me}",c="# Compiled at "+(new Date).getTime()+"\n",d="/apps/_design/bell/manifest.default.appcache",e="/apps/_design/bell",f=e+"/manifest.appcache";a.once("sync",function(){_.each(a.models,function(a){_.each(a.get("_attachments"),function(b,d,e){"manifest.appcache"!==d&&(c+=encodeURI("/apps/"+a.id+"/"+d)+"\n")})}),App.trigger("compile:appsListReady")}),a.fetch(),App.once("compile:appsListReady",function(){$.get(d,function(a){var d=a.replace(b,c);$.getJSON(e,function(a){var b=new XMLHttpRequest;b.open("PUT",f+"?rev="+a._rev,!0),b.onload=function(a){App.trigger("compile:done")},b.setRequestHeader("Content-type","text/cache-manifest"),b.send(new Blob([d],{type:"text/plain"}))})})}),App.once("compile:done",function(){alert("menifist file is creted in Bell-apps")})},CompileManifest:function(){App.startActivityIndicator();var a=new App.Collections.Resources,b=new App.Collections.Apps,c=new App.Collections.Configurations,d=new App.Collections.membercourseprogresses,e=new App.Collections.Languages,f=new App.Collections.Members,g=new App.Collections.listRCollection,h=new App.Collections.Members,i=new App.Models.Member({_id:$.cookie("Member._id")});i.fetch({async:!1});var j=i.get("login");h.login=j;var k=new App.Collections.Meetups,l=new App.Collections.MemberGroups;l.memberId=$.cookie("Member._id");var m=new App.Collections.Reports,n=$.cookie("Member._id"),o=$.cookie("Member.login"),p="/devices/_design/all",q="/apps/_design/bell/manifest.default.appcache",r="/apps/_design/bell/update.default.html",s=new App.Collections.shelfResource;s.compile=!0;var t=p+"/manifest.appcache",u=p+"/update.html",v="{replace me}",w="# Compiled at "+(new Date).getTime()+"\n";a.on("sync",function(){App.trigger("compile:resourceListReady")}),App.once("compile:resourceListReady",function(){b.once("sync",function(){_.each(b.models,function(a){_.each(a.get("_attachments"),function(b,c,d){w+=encodeURI("/apps/"+a.id+"/"+c)+"\n"})}),App.trigger("compile:configurations")}),b.fetch()}),App.once("compile:configurations",function(){c.once("sync",function(){_.each(c.models,function(a){w+=encodeURI("/configurations/_all_docs?include_docs=true")+"\n"}),App.trigger("compile:languages")}),c.fetch()}),App.once("compile:languages",function(){e.once("sync",function(){_.each(e.models,function(a){w+=encodeURI("/languages/_all_docs?include_docs=true")+"\n"}),App.trigger("compile:members")}),e.fetch()}),App.once("compile:members",function(){f.once("sync",function(){w+=encodeURI("/members/_design/bell/_view/Members?include_docs=true")+"\n",_.each(f.models,function(a){w+=encodeURI("/members/"+a.id)+"\n"}),App.trigger("compile:shelfResource")}),f.fetch()}),App.once("compile:shelfResource",function(){s.once("sync",function(){w+='/shelf/_design/bell/_view/DuplicateDetection?include_docs=true&key="'+n+'"\n',_.each(s.models,function(a){var b=a.get("resourceId");console.log(b);var c=new App.Models.Resource({_id:b});c.fetch({success:function(a){w+=encodeURI("/resources/"+b)+"\n","Resource"==c.get("kind")&&c.get("_attachments")&&_.each(c.get("_attachments"),function(a,c,d){w+=encodeURI("/resources/"+b+"/"+c)+"\n"})}})}),App.trigger("compile:collectionList")}),s.fetch()}),App.once("compile:collectionList",function(){g.once("sync",function(){w+=encodeURI("/collectionlist/_design/bell/_view/allrecords?include_docs=true")+"\n",App.trigger("compile:Meetups")}),g.fetch()}),App.once("compile:Meetups",function(){k.once("sync",function(){w+=encodeURI("/meetups/_all_docs?include_docs=true")+"\n",w+=encodeURI('/usermeetups/_design/bell/_view/getUsermeetups?key="'+n+'"&include_docs=true')+"\n",w+=encodeURI('/members/_design/bell/_view/MembersByLogin?include_docs=true&key="'+o+'"')+"\n",_.each(k.models,function(a){w+=encodeURI("/meetups/"+a.id)+"\n"}),App.trigger("compile:Groups")}),k.fetch()}),App.once("compile:Groups",function(){l.once("sync",function(){w+=encodeURI("/groups/_all_docs?include_docs=true")+"\n",w+=encodeURI('/groups/_design/bell/_view/GetCourses?key="'+n+'"&include_docs=true')+"\n",_.each(l.models,function(a){w+=encodeURI("/groups/"+a.id)+"\n",w+=encodeURI('/coursestep/_design/bell/_view/StepsData?key="'+a.id+'"&include_docs=true')+"\n",d.courseId=a.id,d.memberId=n,d.fetch({success:function(){w+='/membercourseprogress/_design/bell/_view/GetMemberCourseResult?key=["'+n+'","'+a.id+'"]&include_docs=true\n'}}),levels=new App.Collections.CourseLevels,levels.groupId=a.id,levels.fetch({async:!1}),levels.each(function(a){var b=a.get("resourceId");_.each(b,function(a){console.log(a);var b=new App.Models.Resource({_id:a});b.fetch({success:function(c){w+=encodeURI("/resources/"+a)+"\n","Resource"==b.get("kind")&&b.get("_attachments")&&_.each(b.get("_attachments"),function(b,c,d){w+=encodeURI("/resources/"+a+"/"+c)+"\n"})}})},this)},this)}),App.trigger("compile:CommunityReport")}),l.fetch()}),App.once("compile:CommunityReport",function(){m.once("sync",function(){w+=encodeURI("/communityreports/_design/bell/_view/allCommunityReports?include_docs=true")+"\n",_.each(m.models,function(a){w+=encodeURI("/communityreports/"+a.id)+"\n"}),App.trigger("compile:appsListReady")}),m.fetch()}),App.once("compile:appsListReady",function(){$.get(q,function(a){var b=a.replace(v,w);$.getJSON(p,function(a){var c=new XMLHttpRequest;c.open("PUT",t+"?rev="+a._rev,!0),c.onload=function(a){App.trigger("compile:done")},c.setRequestHeader("Content-type","text/cache-manifest"),c.send(new Blob([b],{type:"text/plain"}))})})}),App.once("compile:done",function(){$.get(r,function(a){transformedUpdateHTML=a,$.getJSON(p,function(a){var b=new XMLHttpRequest;b.open("PUT",u+"?rev="+a._rev,!0),b.onload=function(a){App.$el.children(".body").html('<a class="btn" href="'+u+'">Resources compiled. Click here to update your device.</a>')},b.setRequestHeader("Content-type","text/html"),b.send(new Blob([transformedUpdateHTML],{type:"text/plain"}))})})}),a.fetch(),App.stopActivityIndicator()},UpdateManifest:function(){var a="/devices/_design/all",b="/apps/_design/bell/manifest.default.appcache",c=a+"/manifest.appcache",d="{replace me}",e="# Compiled at "+(new Date).getTime()+"\n";$.get(b,function(b){var f=b.replace(d,e);$.getJSON(a,function(a){var b=new XMLHttpRequest;b.open("PUT",c+"?rev="+a._rev,!0),b.onload=function(a){},b.setRequestHeader("Content-type","text/cache-manifest"),b.send(new Blob([f],{type:"text/plain"}))})})},WeeklyReports:function(){var a=new PouchDB("activitylogs"),b=this;a.allDocs({include_docs:!0},function(a,c){if(a)console.log("Error fetching documents of 'activitylogs' db in PouchDB. Please try again or refresh page.");else for(var d=c.rows,e=0;e<c.total_rows;e++){var f=d[e].doc,g=f.logDate,h=new App.Collections.ActivityLog;h.logDate=g,h.fetch({success:function(a,c){if(0==a.length)b.createLogs(f);else{var d=a.first();b.updateLogs(f,d)}},error:function(a){console.log("WeeklyReports:: Error looking for (daily) activitylog doc for today's date in CouchDB")}})}})},createLogs:function(a){var b=(a._id,a._rev,new PouchDB("activitylogs")),c=new App.Models.DailyLog;c.set("logDate",a.logDate),c.set("community",a.community),c.set("resourcesIds",a.resourcesIds),c.set("resources_names",a.resources_names),c.set("resources_opened",a.resources_opened),c.set("male_visits",a.male_visits),c.set("female_visits",a.female_visits),c.set("female_new_signups",a.female_new_signups?a.female_new_signups:0),c.set("male_new_signups",a.male_new_signups?a.male_new_signups:0),c.set("male_rating",a.male_rating),c.set("female_rating",a.female_rating),c.set("male_timesRated",a.male_timesRated),c.set("female_timesRated",a.female_timesRated),c.set("male_opened",a.male_opened),c.set("female_opened",a.female_opened),c.set("male_deleted_count",a.male_deleted_count),c.set("female_deleted_count",a.female_deleted_count),c.save(null,{success:function(c,d){b.remove(a,function(a,b){a&&(console.log("MyApp:: createLogs:: Failed to delete Pouch activitylog doc after it had been synced i-e its data pushed to (community) CouchDB"),console.log(a))})}})},updateLogs:function(a,b){var c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0;a.resources_names&&(e=a.resources_names),b.get("resources_names")&&(f=b.get("resources_names")),a.resourcesIds&&(c=a.resourcesIds),a.resources_opened&&(d=a.resources_opened),b.get("resourcesIds")&&(i=b.get("resourcesIds")),b.get("resources_opened")&&(j=b.get("resources_opened")),b.get("male_visits")&&(k=b.get("male_visits")),b.get("female_visits")&&(l=b.get("female_visits")),n=b.get("male_new_signups")?b.get("male_new_signups"):0,m=b.get("female_new_signups")?b.get("female_new_signups"):0,b.get("male_rating")&&(o=b.get("male_rating")),b.get("female_rating")&&(p=b.get("female_rating")),b.get("male_timesRated")&&(q=b.get("male_timesRated")),b.get("female_timesRated")&&(r=b.get("female_timesRated")),b.get("male_opened")&&(s=b.get("male_opened")),b.get("female_opened")&&(t=b.get("female_opened")),b.get("male_deleted_count")&&(g=b.get("male_deleted_count")),b.get("female_deleted_count")&&(h=b.get("female_deleted_count")),k=parseInt(k)+parseInt(a.male_visits),l=parseInt(l)+parseInt(a.female_visits),n=parseInt(n)+parseInt(a.male_new_signups?a.male_new_signups:0),m=parseInt(m)+parseInt(a.female_new_signups?a.female_new_signups:0),h=parseInt(h)+parseInt(a.female_deleted_count?a.female_deleted_count:0),g=parseInt(g)+parseInt(a.male_deleted_count?a.male_deleted_count:0);for(var u,v,w=0;w<c.length;w++)u=c[w],v=i.indexOf(u),-1==v?(i.push(u),o.push(a.male_rating[w]),p.push(a.female_rating[w]),q.push(a.male_timesRated[w]),r.push(a.female_timesRated[w])):(o[v]=parseInt(o[v])+parseInt(a.male_rating[w]),p[v]=parseInt(p[v])+parseInt(a.female_rating[w]),q[v]=parseInt(q[v])+parseInt(a.male_timesRated[w]),r[v]=parseInt(r[v])+parseInt(a.female_timesRated[w]));for(w=0;w<d.length;w++)u=d[w],v=j.indexOf(u),-1==v?(j.push(u),s.push(a.male_opened[w]),t.push(a.female_opened[w])):(s[v]=parseInt(s[v])+parseInt(a.male_opened[w]),t[v]=parseInt(t[v])+parseInt(a.female_opened[w]));b.set("resources_names",f),b.set("resourcesIds",i),b.set("resources_opened",j),b.set("male_visits",k),b.set("female_visits",l),b.set("male_new_signups",n),b.set("female_new_signups",m),b.set("male_rating",o),b.set("female_rating",p),b.set("male_timesRated",q),b.set("female_timesRated",r),b.set("male_opened",s),b.set("female_opened",t),b.set("male_deleted_count",g),b.set("female_deleted_count",h);var x=new PouchDB("activitylogs");b.save(null,{success:function(b,c){x.remove(a,function(a,b){a&&(console.log("MyAppRouter:: updateLogs:: Failed to delete Pouch activitylog doc after it is synced i-e its data pushed to (community) CouchDB"),console.log(a))})}})},LogActivity:function(a,b,c){var d=new App.Views.ActivityReport,e="community",f=Backbone.Collection.extend({url:App.Server+"/configurations/_all_docs?include_docs=true"}),g=new f;g.fetch({async:!1});var h=g.first(),i=h.toJSON();i.rows[0].doc.type&&(e=i.rows[0].doc.type);var j=new App.Collections.ActivityLog;j.startkey=this.changeDateFormat(b),j.endkey=this.changeDateFormat(c),"all"!=a&&(j.name=a),j.fetch({async:!1});var k=j.first();void 0==k&&alert("No Activity Logged for this period");var l=k.get("resourcesIds"),m=[],n=[];k.get("resources_names")&&(n=k.get("resources_names")),k.get("resources_opened")&&(m=k.get("resources_opened"));var o=0;k.get("male_visits")&&(o=k.get("male_visits"));var p=0;k.get("female_visits")&&(p=k.get("female_visits"));var q=[];k.get("male_rating")&&(q=k.get("male_rating"));var r=[];k.get("female_rating")&&(r=k.get("female_rating"));var s=[];k.get("male_timesRated")&&(s=k.get("male_timesRated"));var t=[];k.get("female_timesRated")&&(t=k.get("female_timesRated"));var u=[];k.get("male_opened")&&(u=k.get("male_opened"));var v=[];k.get("female_opened")&&(v=k.get("female_opened")),j.each(function(a,b){if(b>0){o+=a.get("male_visits"),p+=a.get("female_visits"),resourcesIds=a.get("resourcesIds"),resourcesOpened=a.get("resources_opened"),resourcesNames=a.get("resources_names");for(var c=0;c<resourcesIds.length;c++)resId=resourcesIds[c],b=l.indexOf(resId),-1==b?(l.push(resId),q.push(a.get("male_rating")[c]),r.push(a.get("female_rating")[c]),s.push(a.get("male_timesRated")[c]),t.push(a.get("female_timesRated")[c])):(q[b]=q[b]+a.get("male_rating")[c],r[b]=r[b]+a.get("female_rating")[c],s[b]=s[b]+a.get("male_timesRated")[c],t[b]=t[b]+a.get("female_timesRated")[c]);if(resourcesOpened)for(var c=0;c<resourcesOpened.length;c++)resId=resourcesOpened[c],b=m.indexOf(resId),-1==b?(n.push(resourcesNames[c]),m.push(resId),u.push(a.get("male_opened")[c]),v.push(a.get("female_opened")[c])):(u[b]=u[b]+a.get("male_opened")[c],v[b]=v[b]+a.get("female_opened")[c])}});for(var w=[],x=[],y=0;y<m.length;y++)w.push(u[y]+v[y]);var z=[],A=5;z=w.length>=A?this.findIndicesOfMax(w,A):this.findIndicesOfMax(w,w.length);var B,C;if(w.length>0)for(var D,E,y=0;y<z.length;y++){var F=new App.Models.Resource({_id:m[z[y]]});F.fetch({async:!1});var G=F.get("title");D={resourceName:G,timesOpenedCumulative:w[z[y]],timesOpenedByMales:u[z[y]],timesOpenedByFemales:v[z[y]]},-1===(E=l.indexOf(m[z[y]]))?(D.avgRatingCumulative="N/A",D.avgRatingByMales="N/A",D.avgRatingByFemales="N/A",D.timesRatedByMales="N/A",D.timesRatedByFemales="N/A",D.timesRatedCumulative="N/A"):(B=s[E]+t[E],C=q[E]+r[E],D.avgRatingCumulative=Math.round(C/B*100)/100,D.avgRatingByMales=q[E],D.avgRatingByFemales=r[E],D.timesRatedByMales=s[E],D.timesRatedByFemales=t[E],D.timesRatedCumulative=B),x.push(D)}for(var H=[],I=[],J=[],K=5,y=0;y<l.length;y++)B=s[y]+t[y],C=q[y]+r[y],H.push(C/B);var L=[],M=[];if(H.length>=A?(L=this.findIndicesOfMax(H,A),M=this.findIndicesOfMin(H,K)):(L=this.findIndicesOfMax(H,H.length),M=this.findIndicesOfMin(H,H.length)),H.length>0){for(var N,O,y=0;y<L.length;y++){var F=new App.Models.Resource({_id:l[L[y]]});F.fetch({async:!1});var G=F.get("title");B=s[L[y]]+t[L[y]],N={resourceName:G,avgRatingCumulative:Math.round(100*H[L[y]])/100,avgRatingByMales:q[L[y]],avgRatingByFemales:r[L[y]],timesRatedByMales:s[L[y]],timesRatedByFemales:t[L[y]],timesRatedCumulative:s[L[y]]+t[L[y]]},-1===(E=m.indexOf(l[L[y]]))?(N.timesOpenedByMales="N/A",N.timesOpenedByFemales="N/A",N.timesOpenedCumulative="N/A"):(N.timesOpenedByMales=u[E],N.timesOpenedByFemales=v[E],N.timesOpenedCumulative=w[E]),I.push(N)}for(var y=0;y<M.length;y++){B=s[M[y]]+t[M[y]];var F=new App.Models.Resource({_id:l[M[y]]});F.fetch({async:!1});var G=F.get("title");O={resourceName:G,avgRatingCumulative:Math.round(100*H[M[y]])/100,avgRatingByMales:q[M[y]],avgRatingByFemales:r[M[y]],timesRatedByMales:s[M[y]],timesRatedByFemales:t[M[y]],timesRatedCumulative:s[M[y]]+t[M[y]]},-1===(E=m.indexOf(l[M[y]]))?(O.timesOpenedByMales="N/A",O.timesOpenedByFemales="N/A",O.timesOpenedCumulative="N/A"):(O.timesOpenedByMales=u[E],O.timesOpenedByFemales=v[E],O.timesOpenedCumulative=w[E]),J.push(O)}}console.log(I);var P={Visits:{male:o,female:p},Most_Freq_Open:x,Highest_Rated:I,Lowest_Rated:J};d.data=P,d.startDate=b,d.endDate=c,d.CommunityName=a,d.render(),App.$el.children(".body").html(d.el)},findIndicesOfMax:function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(d),c.length>b&&(c.sort(function(b,c){return a[c]-a[b]}),c.pop());return a.length<=b&&c.sort(function(b,c){return a[c]-a[b]}),c},findIndicesOfMin:function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(d),c.length>b&&(c.sort(function(b,c){return a[b]-a[c]}),c.pop());return a.length<=b&&c.sort(function(b,c){return a[b]-a[c]}),c},setNeedOptimizedBit:function(){var a=0,b=new App.Collections.Resources;b.fetch({async:!1}),b.each(function(b){"PDF.js"===b.get("openWith")&&void 0==b.get("need_optimization")&&(b.set({need_optimization:!0}),b.save(),console.log("Done")),console.log(a),a++})}}))});